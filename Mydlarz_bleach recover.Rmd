---
title: 'Gates & Mydlarz et al: 2014 - 2016 bleaching and recovery of Montipora capitata'
author: "Chris Wall"
date: "7/7/2017"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---
```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
## load packages
library(lmerTest)
library(lmtest)
library(lme4)
library(car)
library(effects)
library(gplots)
library(plotrix)
library(psych)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(MASS)
library(lsmeans)
library(pbkrtest)
library(cowplot)
library(devtools)
library(dplyr)
#install_github("vqv/ggbiplot")
#library(ggbiplot)

```
## Background
Data is from Kāne'ohe Bay, O'ahu, Hawai'i. Data extends across **two archipelagic bleaching events and the subsequent recovery periods** where tempertaure stress subsided. Data periods represent:  
- first bleaching (October 2014) 
- first recovery (February 2015) 
- second bleaching (October 2015)  
- second recovery (February 2016)  

Physiological and immunological parameters were collected from from *Montipora capitata* collected from two locations (Sites):  
- Lilipuna -- a shallow fringing reef west of the Hawaii Insititute of Marine Biology  
- Reef 14 -- a shallow inshore patch reef in central Kāne'ohe Bay

**Lilipuna** has been categorized as experiencing near shore impacts from freshwater inundation, subteranean groundwater discharge, and seawater biogeochemistry influeces by long residence times, low flow, and riverine/terrigenous nutrient inputs. Additionally, pCO2 flux at this site is "moderate", with on average ~200ppm pCO2 +/- flux

**Reef 14** has seawater with a shorter residence time, little terrestrial impact, but has a greater pCO2 flux due to reef metabolism. This flux can be substantial, being > 600 ppm pCO2 in a 24h period and reaching maximum values of >900ppm pCO2.

## Environmental data  
  
### Temperature
```{r, temp data, results="hide"}
setwd("data/environmental/Temp data")

# Temperature and light data analysis ------
library(scales); library(zoo); library(lme4); library(lsmeans); library(car)
reefcols <- c("#8dd3c7", "#bebada", "#d9d9d9")

# Import temperature data

#2014 Oct - 2015 Jun
Lil.temp_log1 <- rbind(
        read.csv("Lilipuna/SN_10487932/lilipuna_oct-dec 2014.csv"),
        read.csv("Lilipuna/SN_10487932/lilipuna_dec-feb 2015.csv"))

Lil.temp_log2 <- rbind(
        read.csv("Lilipuna/SN_10487932/lilipuna_feb-apr 2015.csv"),
        read.csv("Lilipuna/SN_10487932/lilipuna_apr-jun 2015.csv"))

#2015 Sep - 2016 Jun
Lil.temp_log4 <- rbind(
        read.csv("Lilipuna/SN_10084646/lilipuna_sep-nov 2015.csv"),
        read.csv("Lilipuna/SN_10084646/lilipuna_nov-jan 2016.csv"),
        read.csv("Lilipuna/SN_10084646/lilipuna_jan-mar 2016.csv"))

Lil.temp_log5<- rbind(
        read.csv("Lilipuna/SN_10084646/lilipuna_apr-jun 2016.csv"))
                   

#2014 Oct - 2015 Jun
Rf14.temp_log1 <- rbind(
  read.csv("Reef 14/SN_10487931/reef14_oct-dec 2014.csv"),
  read.csv("Reef 14/SN_10487931/reef14_dec-feb 2015.csv"))

Rf14.temp_log2 <-rbind( 
  read.csv("Reef 14/SN_10487931/reef14_feb-apr 2015.csv"),
  read.csv("Reef 14/SN_10487931/reef14_apr-jun 2015.csv"))

Rf14.temp_log3 <- 
  read.csv("Reef 14/SN_9893760/reef14_jun-sep 2015.csv")

Rf14.temp_log4 <- rbind(
  read.csv("Reef 14/SN_9893760/reef14_sep-nov 2015.csv"),
  read.csv("Reef 14/SN_9893760/reef14_sep-nov 2015.csv"),
  read.csv("Reef 14/SN_9893760/reef14_nov-jan 2016.csv"),
  read.csv("Reef 14/SN_9893760/reef14_jan-mar 2016.csv"))
  
Rf14.temp_log5<- rbind(
  read.csv("Reef 14/SN_9893760/reef14_apr-jun 2016.csv"))
  

# set date to date class
Lil.temp_log1$Date <- as.Date(Lil.temp_log1$Date, format="%Y/%m/%e")
Lil.temp_log2$Date <- as.Date(Lil.temp_log2$Date, format="%Y/%m/%e")
Lil.temp_log4$Date <- as.Date(Lil.temp_log4$Date, format="%Y/%m/%e")
Lil.temp_log5$Date <- as.Date(Lil.temp_log5$Date, format="%Y/%m/%e")

Rf14.temp_log1$Date <- as.Date(Rf14.temp_log1$Date, format="%Y/%m/%e")
Rf14.temp_log2$Date <- as.Date(Rf14.temp_log2$Date, format="%Y/%m/%e")
Rf14.temp_log3$Date <- as.Date(Rf14.temp_log3$Date, format="%Y/%m/%e")
Rf14.temp_log4$Date <- as.Date(Rf14.temp_log4$Date, format="%Y/%m/%e")
Rf14.temp_log5$Date <- as.Date(Rf14.temp_log5$Date, format="%Y/%m/%e")

##########################

##Calibrate temperature

# Lil.temp_log1: SN_10487932   y = 1.0066x - 0.0085
# Lil.temp_log2: SN_10084646   y = 0.9978x + 0.0815
# Rf14.temp_log1: SN_10487931   y = 1.0047x + 0.0722
# Rf14.temp_log2: SN_9893760   y = 1.0044x - 0.0648

Lil.temp_log1$Temp_Calib<-(1.0066*(Lil.temp_log1$Temp)-0.0085)
Lil.temp_log2$Temp_Calib<-(1.0066*(Lil.temp_log2$Temp)-0.0085)
Lil.temp_log4$Temp_Calib<-(0.9978*(Lil.temp_log4$Temp)-0.0815)
Lil.temp_log5$Temp_Calib<-(0.9978*(Lil.temp_log5$Temp)-0.0815)

Rf14.temp_log1$Temp_Calib<-(1.0047*(Rf14.temp_log1$Temp)-0.0722)
Rf14.temp_log2$Temp_Calib<-(1.0047*(Rf14.temp_log2$Temp)-0.0722)
Rf14.temp_log3$Temp_Calib<-(1.0044*(Rf14.temp_log3$Temp)-0.0648)
Rf14.temp_log4$Temp_Calib<-(1.0044*(Rf14.temp_log4$Temp)-0.0648)
Rf14.temp_log5$Temp_Calib<-(1.0044*(Rf14.temp_log5$Temp)-0.0648)

#compile calibrated data from all time points into single files 

TIMESPAN<-rbind(Rf14.temp_log1, Rf14.temp_log2, Rf14.temp_log3, Rf14.temp_log4, Rf14.temp_log5) #all dates from period

Lil.Temp1 <-Lil.temp_log1 #  Lilipuna temp data start 
Lil.Temp2 <-Lil.temp_log2 # 2 week break in data, Feb until loggers lost
#Lil.Temp3 ==loggers lost
Lil.Temp4 <-Lil.temp_log4 # all data until March 2016 gap
Lil.Temp5 <-Lil.temp_log5 # 2016 March onward

Rf14.Temp1 <- Rf14.temp_log1 
Rf14.Temp2 <- Rf14.temp_log2 
Rf14.Temp3 <- Rf14.temp_log3 
Rf14.Temp4 <- Rf14.temp_log4                       
Rf14.Temp5 <- Rf14.temp_log5                       

#############################
## complete data for both sites across all periods of sampling (2014-2016)
Lil.Temp<-rbind(Lil.temp_log1,Lil.temp_log2, Lil.temp_log4, Lil.temp_log5)
write.csv(Lil.Temp, "Lilipuna temp all.csv")

Rf14.Temp<-rbind(Rf14.Temp1,Rf14.Temp2, Rf14.Temp3, Rf14.Temp4, Rf14.Temp5)
write.csv(Rf14.Temp, "Reef14 temp all.csv")

#############################

# Aggregate temperature data by daily mean, minimum, and maximum

TIMESPAN_split<-split(TIMESPAN, f=TIMESPAN$Date 
                     < as.Date("2014-10-10", format="%F"))

Lil.split1 <- split(Lil.Temp1, f=Lil.Temp1$Date 
                      < as.Date("2014-10-10", format="%F"))
Lil.split2 <- split(Lil.Temp2, f=Lil.Temp2$Date 
                    < as.Date("2014-10-10", format="%F"))
Lil.split4 <- split(Lil.Temp4, f=Lil.Temp4$Date 
                   < as.Date("2014-10-10", format="%F"))
Lil.split5 <-split(Lil.Temp5, f=Lil.Temp5$Date 
                     < as.Date("2014-10-10", format="%F"))

Rf14.split1 <- split(Rf14.Temp1, f=Rf14.Temp1$Date 
                       < as.Date("2014-10-10", format="%F"))
Rf14.split2 <- split(Rf14.Temp2, f=Rf14.Temp2$Date 
                     < as.Date("2014-10-10", format="%F"))
Rf14.split3 <- split(Rf14.Temp3, f=Rf14.Temp3$Date 
                    < as.Date("2014-10-10", format="%F"))
Rf14.split4 <- split(Rf14.Temp4, f=Rf14.Temp4$Date 
                     < as.Date("2014-10-10", format="%F"))
Rf14.split5 <- split(Rf14.Temp5, f=Rf14.Temp5$Date 
                     < as.Date("2014-10-10", format="%F"))

##########################
##########################
TIMESPAN_mean <- aggregate(data.frame(mean=TIMESPAN_split[[1]]$Temp_Calib), by=list(Date=TIMESPAN_split[[1]]$Date), FUN=mean)

# daily means
Lil_mean1 <- aggregate(data.frame(mean=Lil.split1[[1]]$Temp_Calib), by=list(Date=Lil.split1[[1]]$Date), FUN=mean)

Lil_mean2 <- aggregate(data.frame(mean=Lil.split2[[1]]$Temp_Calib), by=list(Date=Lil.split2[[1]]$Date), FUN=mean)

Lil_mean4 <- aggregate(data.frame(mean=Lil.split4[[1]]$Temp_Calib), by=list(Date=Lil.split4[[1]]$Date), FUN=mean)

Lil_mean5 <- aggregate(data.frame(mean=Lil.split5[[1]]$Temp_Calib), by=list(Date=Lil.split5[[1]]$Date), FUN=mean)

#######

Rf14_mean1 <- aggregate(data.frame(mean=Rf14.split1[[1]]$Temp_Calib), by=list(Date=Rf14.split1[[1]]$Date), FUN=mean)

Rf14_mean2 <- aggregate(data.frame(mean=Rf14.split2[[1]]$Temp_Calib), by=list(Date=Rf14.split2[[1]]$Date), FUN=mean)

Rf14_mean3 <- aggregate(data.frame(mean=Rf14.split3[[1]]$Temp_Calib), by=list(Date=Rf14.split3[[1]]$Date), FUN=mean)

Rf14_mean4 <- aggregate(data.frame(mean=Rf14.split4[[1]]$Temp_Calib), by=list(Date=Rf14.split4[[1]]$Date), FUN=mean)

Rf14_mean5 <- aggregate(data.frame(mean=Rf14.split5[[1]]$Temp_Calib), by=list(Date=Rf14.split5[[1]]$Date), FUN=mean)

# daily max temperatures
Lil_max1 <- aggregate(data.frame(max=Lil.split1[[1]]$Temp_Calib), by=list(Date=Lil.split1[[1]]$Date), FUN=max)

Lil_max2 <- aggregate(data.frame(max=Lil.split2[[1]]$Temp_Calib), by=list(Date=Lil.split2[[1]]$Date), FUN=max)

Lil_max4 <- aggregate(data.frame(max=Lil.split4[[1]]$Temp_Calib), by=list(Date=Lil.split4[[1]]$Date), FUN=max)

Lil_max5 <- aggregate(data.frame(max=Lil.split5[[1]]$Temp_Calib), by=list(Date=Lil.split5[[1]]$Date), FUN=max)

######
Rf14_max1 <- aggregate(data.frame(max=Rf14.split1[[1]]$Temp_Calib), by=list(Date=Rf14.split1[[1]]$Date), FUN=max)

Rf14_max2 <- aggregate(data.frame(max=Rf14.split2[[1]]$Temp_Calib), by=list(Date=Rf14.split2[[1]]$Date), FUN=max)

Rf14_max3 <- aggregate(data.frame(max=Rf14.split3[[1]]$Temp_Calib), by=list(Date=Rf14.split3[[1]]$Date), FUN=max)

Rf14_max4 <- aggregate(data.frame(max=Rf14.split4[[1]]$Temp_Calib), by=list(Date=Rf14.split4[[1]]$Date), FUN=max)

Rf14_max5 <- aggregate(data.frame(max=Rf14.split5[[1]]$Temp_Calib), by=list(Date=Rf14.split5[[1]]$Date), FUN=max)

# daily minimum temperature
Lil_min1 <- aggregate(data.frame(min=Lil.split1[[1]]$Temp_Calib), by=list(Date=Lil.split1[[1]]$Date), FUN=min)

Lil_min2 <- aggregate(data.frame(min=Lil.split2[[1]]$Temp_Calib), by=list(Date=Lil.split2[[1]]$Date), FUN=min)

Lil_min4 <- aggregate(data.frame(min=Lil.split4[[1]]$Temp_Calib), by=list(Date=Lil.split4[[1]]$Date), FUN=min)

Lil_min5 <- aggregate(data.frame(min=Lil.split5[[1]]$Temp_Calib), by=list(Date=Lil.split5[[1]]$Date), FUN=min)

######

Rf14_min1 <- aggregate(data.frame(min=Rf14.split1[[1]]$Temp_Calib), by=list(Date=Rf14.split1[[1]]$Date), FUN=min)

Rf14_min2 <- aggregate(data.frame(min=Rf14.split2[[1]]$Temp_Calib), by=list(Date=Rf14.split2[[1]]$Date), FUN=min)

Rf14_min3 <- aggregate(data.frame(min=Rf14.split3[[1]]$Temp_Calib), by=list(Date=Rf14.split3[[1]]$Date), FUN=min)

Rf14_min4 <- aggregate(data.frame(min=Rf14.split4[[1]]$Temp_Calib), by=list(Date=Rf14.split4[[1]]$Date), FUN=min)

Rf14_min5 <- aggregate(data.frame(min=Rf14.split5[[1]]$Temp_Calib), by=list(Date=Rf14.split5[[1]]$Date), FUN=min)


#####################
#####################
# calculate range for temperature from daily min and max

Lil_range1 <- data.frame(Lil_max1, Lil_min1$min); colnames(Lil_range1) <- c("Date","max", "min"); Lil_range1$range<-(Lil_range1$max-Lil_range1$min)

Lil_range2 <- data.frame(Lil_max2, Lil_min2$min); colnames(Lil_range2) <- c("Date","max", "min"); Lil_range2$range<-(Lil_range2$max-Lil_range2$min)

Lil_range4 <- data.frame(Lil_max4, Lil_min4$min); colnames(Lil_range4) <- c("Date","max", "min"); Lil_range4$range<-(Lil_range4$max-Lil_range4$min)

Lil_range5 <- data.frame(Lil_max5, Lil_min5$min); colnames(Lil_range5) <- c("Date","max", "min"); Lil_range5$range<-(Lil_range5$max-Lil_range5$min)

##########

Rf14_range1 <- data.frame(Rf14_max1, Rf14_min1$min); colnames(Rf14_range1) <- c("Date","max", "min"); Rf14_range1$range<-(Rf14_range1$max-Rf14_range1$min)

Rf14_range2 <- data.frame(Rf14_max2, Rf14_min2$min); colnames(Rf14_range2) <- c("Date","max", "min"); Rf14_range2$range<-(Rf14_range2$max-Rf14_range2$min)

Rf14_range3 <- data.frame(Rf14_max3, Rf14_min3$min); colnames(Rf14_range3) <- c("Date","max", "min"); Rf14_range3$range<-(Rf14_range3$max-Rf14_range3$min)

Rf14_range4 <- data.frame(Rf14_max4, Rf14_min4$min); colnames(Rf14_range4) <- c("Date","max", "min"); Rf14_range4$range<-(Rf14_range4$max-Rf14_range4$min)

Rf14_range5 <- data.frame(Rf14_max5, Rf14_min5$min); colnames(Rf14_range5) <- c("Date","max", "min"); Rf14_range5$range<-(Rf14_range5$max-Rf14_range5$min)

#######################

# test for temperature
# compiled files = Lil.Temp and Rf14.Temp
# compiles means = Lilipuna = Lil_mean1, Lil_mean2, Lil_mean4, Lil_mean5
#                = Reef 14 = Rf14_mean1, Rf14_mean2, Rf14_mean3, Rf14_mean4, Rf14_mean5

# removing Reef 14_mean 3 and aligning mean4 gives a balanced dataframe with means for each day matched among sites

Rf14_mean4.amend<-Rf14_mean4[(Rf14_mean4$Date>="2015-09-28"),]

Lil.tempmean.all <-rbind(Lil_mean1, Lil_mean2, Lil_mean4, Lil_mean5)
Rf14.tempmean.all<-rbind(Rf14_mean1, Rf14_mean2, Rf14_mean4.amend, Rf14_mean5)


test.temp<- rbind(
  data.frame(date=Lil.tempmean.all$Date, reef="Lilipuna", temp=Lil.tempmean.all$mean),
  data.frame(date=Rf14.tempmean.all$Date, reef="Reef 14", temp=Rf14.tempmean.all$mean))

lmod2<-lmer(temp~reef + (1|date), data=test.temp)
Anova(lmod2, type=2)
lsmeans(lmod2, "reef", contr="pairwise")

head(test.temp)
aggregate(temp~reef, data=test.temp,mean)
min.temp<-aggregate(temp~reef, data=test.temp, min)
max.temp<-aggregate(temp~reef, data=test.temp, max)

temps<-cbind(Lil.tempmean.all, Rf14.tempmean.all[c(0,2)]); colnames(temps)<-c("Date", "Lil.temp", "Rf14.temp")
temps$temp.diff<-temps$Lil.temp-temps$Rf14.temp

#plot(temps$temp.diff~temps$Date, pch=21, cex=1, ylim=c(-2,2), xaxt="n", xlab="Date", ylab="Temperature (°C)", main="Differences in daily mean temperature at Lilipuna relative to Reef 14", cex.main=0.7)
#axis.Date(1, at=seq(min(temps$Date), max(temps$Date), by="1 mon"), format="%b '%y")
#abline(0,0, lty=2, lwd=2, col="red")
```

### Light
```{r, light data, results="hide"}
setwd("data/environmental/Light data")
# Import light data

# Lilipuna
# 2014 Oct - 2016 Jun
Lil.PAR1<-rbind(
  read.csv("Lilipuna/SN_2485/Lilipuna_2485_T1_oct-dec 2014.csv"),
  read.csv("Lilipuna/SN_2485/Lilipuna_2485_T2_dec-feb 2015.csv"))

Lil.PAR2<-rbind(  
  read.csv("Lilipuna/SN_2485/Lilipuna_2485_T3_feb-apr 2015.csv"),
  read.csv("Lilipuna/SN_2485/Lilipuna_2485_T4_apr-jun 2015.csv"))

Lil.PAR4<-rbind(
  read.csv("Lilipuna/SN_2489/Lilipuna_2489_T6_sep-nov 2015.csv"),
  read.csv("Lilipuna/SN_2489/Lilipuna_2489_T7_nov-jan 2016.csv"),
  read.csv("Lilipuna/SN_2489/Lilipuna_2489_T8_jan-mar 2016.csv"))

Lil.PAR5<-
  read.csv("Lilipuna/SN_2489/Lilipuna_2489_T9_mar-jun 2016.csv")

  
# Reef 14
# 2014 Oct - 2016 Jun
Rf14.PAR1 <- rbind(
  read.csv("Reef 14/SN_2488/Reef 14_2488_T1_oct-dec 2014.csv"),
  read.csv("Reef 14/SN_2488/Reef 14_2488_T2_dec-feb 2015.csv"))

Rf14.PAR2 <- rbind(
  read.csv("Reef 14/SN_2488/Reef 14_2488_T3_feb-apr 2015.csv"),
  read.csv("Reef 14/SN_2488/Reef 14_2488_T4_apr-jun 2015.csv"))

Rf14.PAR3 <- 
  read.csv("Reef 14/SN_2488/Reef 14_2488_T5_jun-sep 2015.csv")

Rf14.PAR4 <- rbind(
  read.csv("Reef 14/SN_2488/Reef 14_2488_T6_sep-nov 2015.csv"),
  read.csv("Reef 14/SN_2488/Reef 14_2488_T7_nov-jan 2016.csv"),
  read.csv("Reef 14/SN_2488/Reef 14_2488_T8_jan-mar 2016.csv"))

Rf14.PAR5 <-
  read.csv("Reef 14/SN_2488/Reef 14_2488_T9_apr-jun 2016.csv")


# Set date to date class
Lil.PAR1$Date <- as.Date(Lil.PAR1$Date, format="%e/%m/%Y")
Lil.PAR2$Date <- as.Date(Lil.PAR2$Date, format="%e/%m/%Y")
Lil.PAR4$Date <- as.Date(Lil.PAR4$Date, format="%e/%m/%Y")
Lil.PAR5$Date <- as.Date(Lil.PAR5$Date, format="%e/%m/%Y")

Rf14.PAR1$Date <- as.Date(Rf14.PAR1$Date, format="%e/%m/%Y")
Rf14.PAR2$Date <- as.Date(Rf14.PAR2$Date, format="%e/%m/%Y")
Rf14.PAR3$Date <- as.Date(Rf14.PAR3$Date, format="%e/%m/%Y")
Rf14.PAR4$Date <- as.Date(Rf14.PAR4$Date, format="%e/%m/%Y")
Rf14.PAR5$Date <- as.Date(Rf14.PAR5$Date, format="%e/%m/%Y")

##########################
# Recalibrate light data
# Lilipuna --- Logger SN: 2485 calibration: y = 23.674x - 48.339 <<< Jen calibration
# Lilipuna --- Logger SN: 2489 calibration: y = 89.459x
# Reef 14  --- Logger SN: 2488 calibration: y = 74.242x
##########################

#Reef 14 -- Odyssey logger 2488

Rf14.PAR1<-Rf14.PAR1[,-5]; head(Rf14.PAR1) #remove "calibrated column"
# integrate raw values over time internal (15min * 60 sec) and calibrate to LiCor
Rf14.PAR1$LiCor_Calibrated<-(Rf14.PAR1$Raw*74.242/(15*60))
  
  Rf14.PAR2<-Rf14.PAR2[,-5]; head(Rf14.PAR2)
  Rf14.PAR2$LiCor_Calibrated<-(Rf14.PAR2$Raw*74.242/(15*60))
  
    Rf14.PAR3<-Rf14.PAR3[,-5]; head(Rf14.PAR3)
    Rf14.PAR3$LiCor_Calibrated<-(Rf14.PAR3$Raw*74.242/(15*60))
    
      Rf14.PAR4<-Rf14.PAR4[,-5]; head(Rf14.PAR4)
      Rf14.PAR4$LiCor_Calibrated<-(Rf14.PAR4$Raw*74.242/(15*60))
      
         Rf14.PAR5<-Rf14.PAR5[,-5]; head(Rf14.PAR5)
         Rf14.PAR5$LiCor_Calibrated<-(Rf14.PAR5$Raw*74.242/(15*60))
         

# Lilipuna -- Odyssey logger 2485 .....calibration approximated, other values are nonsense
Lil.PAR1<-Lil.PAR1[,-5]; head(Lil.PAR1) 
Lil.PAR1$LiCor_Calibrated<-(Lil.PAR1$Raw*82.0/(15*60)); head(Lil.PAR1)
  Lil.PAR2<-Lil.PAR2[,-5]; head(Lil.PAR2)
  Lil.PAR2$LiCor_Calibrated<-(Lil.PAR2$Raw*82.0/(15*60)); head(Lil.PAR2)
  

# Lilipuna -- Odyssey logger 2489 calibration: 
Lil.PAR4<-Lil.PAR4[,-5]; head(Lil.PAR4)
Lil.PAR4$LiCor_Calibrated<-(Lil.PAR4$Raw*89.459/(15*60)); head(Lil.PAR4)
  Lil.PAR5<-Lil.PAR5[,-5]; head(Lil.PAR5)
  Lil.PAR5$LiCor_Calibrated<-(Lil.PAR5$Raw*89.459/(15*60)); head(Lil.PAR5)


# Combine all calibrated data for Lilipuna, Reef 14
Lil.PAR  <- rbind(Lil.PAR1, Lil.PAR2, Lil.PAR4, Lil.PAR5)
write.csv(Lil.PAR, "Lilipuna PAR all.csv")

Rf14.PAR <- rbind(Rf14.PAR1, Rf14.PAR2, Rf14.PAR3, Rf14.PAR4, Rf14.PAR5)
write.csv(Rf14.PAR, "Reef14 PAR all.csv")

#######################
#######################
# compiled data files

Lil.Temp  # Lilipuna temp data
Lil.PAR   # Lilipuna light data

Rf14.Temp # Reef 14 temp data
Rf14.PAR  # Reef 14 light data

########################

# Calculate daily light integrals
# Lilipuna
Lil.L1 <- aggregate(data.frame(mean=Lil.PAR1$LiCor_Calibrated), by=list(Date=Lil.PAR1$Date), FUN=mean)
Lil.L1$dli <- Lil.L1$mean * 0.0864 # Convert to mol.m2.d (daily light integral)

Lil.L2 <- aggregate(data.frame(mean=Lil.PAR2$LiCor_Calibrated), by=list(Date=Lil.PAR2$Date), FUN=mean); Lil.L2$dli <- Lil.L2$mean * 0.0864

Lil.L4 <- aggregate(data.frame(mean=Lil.PAR4$LiCor_Calibrated), by=list(Date=Lil.PAR4$Date), FUN=mean); Lil.L4$dli <- Lil.L4$mean * 0.0864
Lil.L4<-Lil.L4[!(Lil.L4$Date=="2016-03-01"),]

Lil.L5 <- aggregate(data.frame(mean=Lil.PAR5$LiCor_Calibrated), by=list(Date=Lil.PAR5$Date), FUN=mean); Lil.L5$dli <- Lil.L5$mean * 0.0864


#Reef 14
Rf14.L1 <- aggregate(data.frame(mean=Rf14.PAR1$LiCor_Calibrated), by=list(Date=Rf14.PAR1$Date), FUN=mean); Rf14.L1$dli <- Rf14.L1$mean * 0.0864

Rf14.L2 <- aggregate(data.frame(mean=Rf14.PAR2$LiCor_Calibrated), by=list(Date=Rf14.PAR2$Date), FUN=mean); Rf14.L2$dli <- Rf14.L2$mean * 0.0864

Rf14.L3 <- aggregate(data.frame(mean=Rf14.PAR3$LiCor_Calibrated), by=list(Date=Rf14.PAR3$Date), FUN=mean); Rf14.L3$dli <- Rf14.L3$mean * 0.0864

Rf14.L4 <- aggregate(data.frame(mean=Rf14.PAR4$LiCor_Calibrated), by=list(Date=Rf14.PAR4$Date), FUN=mean); Rf14.L4$dli <- Rf14.L4$mean * 0.0864

Rf14.L5 <- aggregate(data.frame(mean=Rf14.PAR5$LiCor_Calibrated), by=list(Date=Rf14.PAR5$Date), FUN=mean); Rf14.L5$dli <- Rf14.L5$mean * 0.0864

# testing for differences among reefs

## DAILY INTEGRATED LIGHT
# Light data dli
# Lil.PAR1-2,4-5  and Rf14.PAR1-5
Lil.PAR.dli.all<-rbind(Lil.L1, Lil.L2, Lil.L4, Lil.L5)
Rf14.PAR.dli.all<-rbind(Rf14.L1, Rf14.L2, Rf14.L3, Rf14.L4, Rf14.L5)

test.light<- rbind(
  data.frame(date=Lil.PAR.dli.all$Date, reef="Lilipuna", dli=Lil.PAR.dli.all$dli),
  data.frame(date=Rf14.PAR.dli.all$Date, reef="Reef 14", dli=Rf14.PAR.dli.all$dli))
lmod1<-lmer(dli~reef + (1|date), data=test.light)
Anova(lmod1, type=2)
lsmeans(lmod1, "reef", contr="pairwise")
```
  
*Temp and Light plot*
```{r, temp and light plot}

#######################
# Plot temp. daily mean temperatures for each reef
#######################

par(mfrow=c(2,1), mar=c(2,4,2,1), mgp=c(2,0.5,0))
k=1; lwd=1 # k-day moving averages
plot(mean ~ Date, TIMESPAN_mean, type="n", ylab="Mean day temp. (°C)", ylim=c(21, 31), xaxt="n", xlab="")
mtext(expression(bold("A")), 2, adj=4.5, las=1, padj=-8)
axis.Date(1, at=seq(min(TIMESPAN_mean$Date), max(TIMESPAN_mean$Date), by="1 mon"), format="%b '%y")
legend("topright", lty=1, col=c(reefcols[1:2], "darkgray"), legend=c("Reef 14","Lilipuna"), lwd=2, bty="n")
with(na.omit(data.frame(date=Rf14_mean1$Date, mean=rollmean(Rf14_mean1$mean, k, fill=NA))), { 
  lines(date, mean, col=reefcols[1], lwd=1.5) 
})
with(na.omit(data.frame(date=Rf14_mean2$Date, mean=rollmean(Rf14_mean2$mean, k, fill=NA))), { 
  lines(date, mean, col=reefcols[1], lwd=1.5) 
})
with(na.omit(data.frame(date=Rf14_mean3$Date, mean=rollmean(Rf14_mean3$mean, k, fill=NA))), { 
  lines(date, mean, col=reefcols[1], lwd=1.5)
})
with(na.omit(data.frame(date=Rf14_mean4$Date, mean=rollmean(Rf14_mean4$mean, k, fill=NA))), { 
  lines(date, mean, col=reefcols[1], lwd=1.5)
})
with(na.omit(data.frame(date=Rf14_mean5$Date, mean=rollmean(Rf14_mean5$mean, k, fill=NA))), { 
  lines(date, mean, col=reefcols[1], lwd=1.5) 
})
with(na.omit(data.frame(date=Lil_mean1$Date, mean=rollmean(Lil_mean1$mean, k, fill=NA))), {
  lines(date, mean, col=reefcols[2], lwd=1.5)
})
with(na.omit(data.frame(date=Lil_mean2$Date, mean=rollmean(Lil_mean2$mean, k, fill=NA))), {
  lines(date, mean, col=reefcols[2], lwd=1.5)
})
with(na.omit(data.frame(date=Lil_mean4$Date, mean=rollmean(Lil_mean4$mean, k, fill=NA))), { 
  lines(date, mean, col=reefcols[2], lwd=1.5) 
})
with(na.omit(data.frame(date=Lil_mean5$Date, mean=rollmean(Lil_mean5$mean, k, fill=NA))), { 
  lines(date, mean, col=reefcols[2], lwd=1.5) 
})

###########################
# Plot daily light integrals
###########################

k=1; lwd=1 # k-day moving averages
plot(mean ~ Date, TIMESPAN_mean, type="n", ylab=(expression(paste("DLI mol photons", ~m^-2, ~d^-1, sep=""))), xaxt="n", xlab="", ylim=c(0,40))
mtext(expression(bold("B")), 2, adj=4.5, las=1, padj=-8)
axis.Date(1, at=seq(min(TIMESPAN_mean$Date), max(TIMESPAN_mean$Date), by="1 mon"), format="%b '%y")
#legend("topleft", lty=1, col=c(reefcols[1:2], "darkgray"), legend=c("Reef 14","Lilipuna"), lwd=2, bty="n")
with(na.omit(data.frame(date=Lil.L1$Date, dli=rollmean(Lil.L1$dli, k, fill=NA))), lines(date, dli, col=reefcols[2], lwd=lwd))
with(na.omit(data.frame(date=Lil.L2$Date, dli=rollmean(Lil.L2$dli, k, fill=NA))), lines(date, dli, col=reefcols[2], lwd=lwd))
with(na.omit(data.frame(date=Lil.L4$Date, dli=rollmean(Lil.L4$dli, k, fill=NA))), lines(date, dli, col=reefcols[2], lwd=lwd))
with(na.omit(data.frame(date=Lil.L5$Date, dli=rollmean(Lil.L5$dli, k, fill=NA))), lines(date, dli, col=reefcols[2], lwd=lwd))
with(na.omit(data.frame(date=Rf14.L1$Date, dli=rollmean(Rf14.L1$dli, k, fill=NA))), lines(date, dli, col=reefcols[1], lwd=lwd))
with(na.omit(data.frame(date=Rf14.L2$Date, dli=rollmean(Rf14.L2$dli, k, fill=NA))), lines(date, dli, col=reefcols[1], lwd=lwd))
with(na.omit(data.frame(date=Rf14.L3$Date, dli=rollmean(Rf14.L3$dli, k, fill=NA))), lines(date, dli, col=reefcols[1], lwd=lwd))
with(na.omit(data.frame(date=Rf14.L4$Date, dli=rollmean(Rf14.L4$dli, k, fill=NA))), lines(date, dli, col=reefcols[1], lwd=lwd))
with(na.omit(data.frame(date=Rf14.L5$Date, dli=rollmean(Rf14.L5$dli, k, fill=NA))), lines(date, dli, col=reefcols[1], lwd=lwd))

dev.copy(pdf, "figures/Temp.PAR.pdf", width=8, height=5)
dev.off()


```


## Ecological data
  
### 2014-2015 B/R
```{r, ecology}
#### Bleachign and recovery for year 1
data<-read.csv("data/ecology/Reef survey 2014-2015.csv") #import your data file here

##### make a dataframe for data means by transect (= unit of replication)

coral<-aggregate(coral.cover~Transect+Habitat+Site+Status, data=data, sum)
healthy<-aggregate(coral.pigmented~Transect+Habitat+Site+Status, data=data, sum)
pale<-aggregate(coral.pale~Transect+Habitat+Site+Status, data=data, sum)
white<-aggregate(coral.white~Transect+Habitat+Site+Status, data=data, sum)
MC<-aggregate(MC~Transect+Habitat+Site+Status, data=data, sum)
MC.healthy<-aggregate(MC.pigmented~Transect+Habitat+Site+Status, data=data, sum)
MC.pale<-aggregate(MC.pale~Transect+Habitat+Site+Status, data=data, sum)
MC.white<-aggregate(MC.white~Transect+Habitat+Site+Status, data=data, sum)

df<-cbind(coral, healthy[c(5,0)], pale[c(5,0)], white[c(5,0)], MC[c(5,0)], MC.healthy[c(5,0)], MC.pale[c(5,0)], MC.white[c(5,0)])
df<-df[!(df$Habitat=="Slope"),] # remove "Slope" habitat
df<- df %>% mutate(
  totalcoral.bleach= coral.pale + coral.white,
  totalMC.bleach= MC.pale + MC.white)

survey.yr1<-subset(df, select = c(-coral.pale, -coral.white, -MC.pale, -MC.white))
  
# use "survey.yr1" to test mean and SD for YEAR 1 (2014-2015)
# df.m + dfSE to make figures
coral<-aggregate(coral.cover~Habitat+Site+Status, data=survey.yr1, mean)
healthy<-aggregate(coral.pigmented~Habitat+Site+Status, data=survey.yr1, mean)
bleached<-aggregate(totalcoral.bleach~Habitat+Site+Status, data=survey.yr1, mean)

MC<-aggregate(MC~Habitat+Site+Status, data=survey.yr1, mean)
MC.healthy<-aggregate(MC.pigmented~Habitat+Site+Status, data=survey.yr1, mean)
MC.bleach<-aggregate(totalMC.bleach~Habitat+Site+Status, data=survey.yr1, mean)

df.m<-cbind(coral, healthy[c(4,0)], bleached[c(4,0)], MC[c(4,0)], MC.healthy[c(4,0)], MC.bleach[c(4,0)])
df.m

# SD
coralSD<-aggregate(coral.cover~+Habitat+Site+Status, data=survey.yr1, sd)
healthySD<-aggregate(coral.pigmented~Habitat+Site+Status, data=survey.yr1, sd)
bleachedSD<-aggregate(totalcoral.bleach~Habitat+Site+Status, data=survey.yr1, sd)

MCSD<-aggregate(MC~Habitat+Site+Status, data=survey.yr1, sd)
MC.healthySD<-aggregate(MC.pigmented~Habitat+Site+Status, data=survey.yr1, sd)
MC.bleachSD<-aggregate(totalMC.bleach~Habitat+Site+Status, data=df, sd)

dfSD<-cbind(coralSD, healthySD[c(4,0)], bleachedSD[c(4,0)], MCSD[c(4,0)], MC.healthySD[c(4,0)], MC.bleachSD[c(4,0)])
dfSD

################## start back here

df.fig<-cbind(df.m, dfSD[c(4:9,0)]); colnames(df.fig) <-c("Habitat", "Site", "Status", "coral.cover", "coral.pigmented", "totalcoral.bleach", "MC", "MC.pigmented", "totalMC.bleach", "coral.SD", "coral.pigSD", "coral.blSD", "MCSD", "MC.pigSD", "MC.blSD"); df.fig

#capture.output(df.fig, file="ecology summary 2014-15.csv")

########################
## color palettes ######
########################

colors<-c("gray80", "gray63")

# order the factor
df.fig$Habitat <- factor(df.fig$Habitat, c("Flat","Crest"))

# all coral cover
Fig1 <- ggplot(df.fig, aes(x=Site, y=coral.cover, fill=Habitat)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  geom_errorbar(aes(ymin=coral.cover-coral.SD, ymax= coral.cover+coral.SD), width=0.1,
  position=position_dodge(.9)) +
  xlab(expression(bold("Reef Site"))) +
  scale_fill_manual(values=colors, breaks=c("Flat","Crest")) +
  ylab(expression(bold(paste("coral cover")))) +
  scale_y_continuous(limits=c(0,1),oob = rescale_none) +
  facet_grid(.~Status)
Fig1

# bleached coral
Fig2 <- ggplot(df.fig, aes(x=Site, y=totalcoral.bleach, fill=Habitat)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  geom_errorbar(aes(ymin=totalcoral.bleach-coral.blSD, ymax= totalcoral.bleach+coral.blSD), width=0.1, position=position_dodge(.9)) +
  xlab(expression(bold("Reef Site"))) +
  scale_fill_manual(values=colors, breaks=c("Flat","Crest")) +
  ylab(expression(bold(paste("bleached corals")))) +
  scale_y_continuous(limits=c(0,1),oob = rescale_none)+
  facet_grid(.~Status)
Fig2

##############
# MC corals
Fig3 <- ggplot(df.fig, aes(x=Site, y=MC, fill=Habitat)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  geom_errorbar(aes(ymin=MC-MCSD, ymax= MC+MCSD), width=0.1,position=position_dodge(.9)) +
  xlab(expression(bold("Reef Site"))) +
  scale_fill_manual(values=colors, breaks=c("Flat","Crest")) +
  ylab(expression(bold(paste(~bolditalic("M. capitata")~cover, sep="")))) +
  scale_y_continuous(limits=c(0,1.05),oob = rescale_none)+
  facet_grid(.~Status)
Fig3

# bleached MC coral
Fig4 <- ggplot(df.fig, aes(x=Site, y=totalMC.bleach, fill=Habitat)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  geom_errorbar(aes(ymin=totalMC.bleach-MC.blSD, ymax= totalMC.bleach+MC.blSD), width=0.1, position=position_dodge(.9)) +
  xlab(expression(bold("Reef Site"))) +
  scale_fill_manual(values=colors, breaks=c("Flat","Crest")) +
  ylab(expression(bold(paste(~bolditalic("M. capitata")~bleached, sep="")))) +
  scale_y_continuous(limits=c(0,1),oob = rescale_none)+
  facet_grid(.~Status)
Fig4

############
############
#export figures
library("cowplot")

#############
# color figures all corals
Fig_2014_2015_surveys<-plot_grid(Fig1, Fig2, Fig3, Fig4,
     labels=c('A', 'B', 'C', 'D'), label_size=15, hjust=-6, vjust= 3, ncol=2, nrow=2);
Fig_2014_2015_surveys

##### save the figure and export to directory? ####
dev.copy(pdf, "figures/year1.surveys.pdf", width=11, height=8)
dev.off()
```
### year2 bleaching-recovery
```{r, ecology 2}

#### Bleaching and recovery for year 1
data<-read.csv("data/ecology/Reef survey 2015-2016.csv") #import your data file here

##### make a dataframe for data means by transect (= unit of replication)

coral<-aggregate(coral.cover~Transect+Habitat+Site+Status, data=data, sum)
healthy<-aggregate(coral.pigmented~Transect+Habitat+Site+Status, data=data, sum)
pale<-aggregate(coral.pale~Transect+Habitat+Site+Status, data=data, sum)
white<-aggregate(coral.white~Transect+Habitat+Site+Status, data=data, sum)
MC<-aggregate(MC~Transect+Habitat+Site+Status, data=data, sum)
MC.healthy<-aggregate(MC.pigmented~Transect+Habitat+Site+Status, data=data, sum)
MC.pale<-aggregate(MC.pale~Transect+Habitat+Site+Status, data=data, sum)
MC.white<-aggregate(MC.white~Transect+Habitat+Site+Status, data=data, sum)

df<-cbind(coral, healthy[c(5,0)], pale[c(5,0)], white[c(5,0)], MC[c(5,0)], MC.healthy[c(5,0)], MC.pale[c(5,0)], MC.white[c(5,0)])
df<-df[!(df$Habitat=="Slope"),] # remove "Slope" habitat
df<- df %>% mutate(
  totalcoral.bleach= coral.pale + coral.white,
  totalMC.bleach= MC.pale + MC.white)

survey.yr1<-subset(df, select = c(-coral.pale, -coral.white, -MC.pale, -MC.white))
  
# use "survey.yr1" to test mean and SD for YEAR 1 (2014-2015)
# df.m + dfSE to make figures
coral<-aggregate(coral.cover~Habitat+Site+Status, data=survey.yr1, mean)
healthy<-aggregate(coral.pigmented~Habitat+Site+Status, data=survey.yr1, mean)
bleached<-aggregate(totalcoral.bleach~Habitat+Site+Status, data=survey.yr1, mean)

MC<-aggregate(MC~Habitat+Site+Status, data=survey.yr1, mean)
MC.healthy<-aggregate(MC.pigmented~Habitat+Site+Status, data=survey.yr1, mean)
MC.bleach<-aggregate(totalMC.bleach~Habitat+Site+Status, data=survey.yr1, mean)

df.m<-cbind(coral, healthy[c(4,0)], bleached[c(4,0)], MC[c(4,0)], MC.healthy[c(4,0)], MC.bleach[c(4,0)])
df.m

# SD
coralSD<-aggregate(coral.cover~+Habitat+Site+Status, data=survey.yr1, sd)
healthySD<-aggregate(coral.pigmented~Habitat+Site+Status, data=survey.yr1, sd)
bleachedSD<-aggregate(totalcoral.bleach~Habitat+Site+Status, data=survey.yr1, sd)

MCSD<-aggregate(MC~Habitat+Site+Status, data=survey.yr1, sd)
MC.healthySD<-aggregate(MC.pigmented~Habitat+Site+Status, data=survey.yr1, sd)
MC.bleachSD<-aggregate(totalMC.bleach~Habitat+Site+Status, data=df, sd)

dfSD<-cbind(coralSD, healthySD[c(4,0)], bleachedSD[c(4,0)], MCSD[c(4,0)], MC.healthySD[c(4,0)], MC.bleachSD[c(4,0)])
dfSD

################## start back here

df.fig<-cbind(df.m, dfSD[c(4:9,0)]); colnames(df.fig) <-c("Habitat", "Site", "Status", "coral.cover", "coral.pigmented", "totalcoral.bleach", "MC", "MC.pigmented", "totalMC.bleach", "coral.SD", "coral.pigSD", "coral.blSD", "MCSD", "MC.pigSD", "MC.blSD"); df.fig

#capture.output(df.fig, file="ecology summary 2014-15.csv")

########################
## color palettes ######
########################

colors<-c("gray80", "gray63")

# order the factor
df.fig$Habitat <- factor(df.fig$Habitat, c("Flat","Crest"))

# all coral cover
Fig1 <- ggplot(df.fig, aes(x=Site, y=coral.cover, fill=Habitat)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  geom_errorbar(aes(ymin=coral.cover-coral.SD, ymax= coral.cover+coral.SD), width=0.1,
  position=position_dodge(.9)) +
  xlab(expression(bold("Reef Site"))) +
  scale_fill_manual(values=colors, breaks=c("Flat","Crest")) +
  ylab(expression(bold(paste("coral cover")))) +
  scale_y_continuous(limits=c(0,1),oob = rescale_none) +
  facet_grid(.~Status)
Fig1

# bleached coral
Fig2 <- ggplot(df.fig, aes(x=Site, y=totalcoral.bleach, fill=Habitat)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  geom_errorbar(aes(ymin=totalcoral.bleach-coral.blSD, ymax= totalcoral.bleach+coral.blSD), width=0.1, position=position_dodge(.9)) +
  xlab(expression(bold("Reef Site"))) +
  scale_fill_manual(values=colors, breaks=c("Flat","Crest")) +
  ylab(expression(bold(paste("bleached corals")))) +
  scale_y_continuous(limits=c(0,1),oob = rescale_none)+
  facet_grid(.~Status)
Fig2

##############
# MC corals
Fig3 <- ggplot(df.fig, aes(x=Site, y=MC, fill=Habitat)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  geom_errorbar(aes(ymin=MC-MCSD, ymax= MC+MCSD), width=0.1,position=position_dodge(.9)) +
  xlab(expression(bold("Reef Site"))) +
  scale_fill_manual(values=colors, breaks=c("Flat","Crest")) +
  ylab(expression(bold(paste(~bolditalic("M. capitata")~cover, sep="")))) +
  scale_y_continuous(limits=c(0,1.05),oob = rescale_none)+
  facet_grid(.~Status)
Fig3

# bleached MC coral
Fig4 <- ggplot(df.fig, aes(x=Site, y=totalMC.bleach, fill=Habitat)) + 
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  geom_errorbar(aes(ymin=totalMC.bleach-MC.blSD, ymax= totalMC.bleach+MC.blSD), width=0.1, position=position_dodge(.9)) +
  xlab(expression(bold("Reef Site"))) +
  scale_fill_manual(values=colors, breaks=c("Flat","Crest")) +
  ylab(expression(bold(paste(~bolditalic("M. capitata")~bleached, sep="")))) +
  scale_y_continuous(limits=c(0,1),oob = rescale_none)+
  facet_grid(.~Status)
Fig4

############
############
#export figures
library("cowplot")

#############
# color figures all corals
Fig_2015_2016_surveys<-plot_grid(Fig1, Fig2, Fig3, Fig4,
     labels=c('A', 'B', 'C', 'D'), label_size=15, hjust=-6, vjust= 3, ncol=2, nrow=2);
Fig_2015_2016_surveys

##### save the figure and export to directory? ####
dev.copy(pdf, "figures/year2.surveys.pdf", width=11, height=8)
dev.off()
```

```{r, year1 B and R stats, eval=FALSE}
##################
###############
##########
#####
#
## TOTAL CORAL COMMUNITY BLEACHING ACROSS SITES AND HABITATS

################
# total coral cover
################

Habitat<-df$Habitat
Site<-df$Site

hist(df$coral.cover)

mod<-lm(coral.cover~Site*Habitat, data=df)

R <- resid(mod) #save glm residuals
op<-par(mfrow = c(2,2), mar=c(5,4,1,2))
plot(mod, add.smooth = FALSE, which=1)
QQ <- qqnorm(R, main = "") 
QQline <- qqline(R)
hist(R, xlab="Residuals", main ="")
plot(Site, R, xlab="Site", ylab="Residuals")
plot(Habitat, R, xlab="Habitat", ylab="Residuals")

shapiro <- shapiro.test(R) #runs a normality test on residuals
shapiro # null = normally distrubuted (P<0.05 = non-normal)

# Model
mod<-lm(coral.cover~Site*Habitat, data=df); summary(mod)
Anova(mod, type=3)


################
# pigmented coral
################
hist(df$coral.pigmented)

mod<-lm(coral.pigmented~Site*Habitat, data=df)

R <- resid(mod) #save glm residuals
op<-par(mfrow = c(2,2), mar=c(5,4,1,2))
plot(mod, add.smooth = FALSE, which=1)
QQ <- qqnorm(R, main = "") 
QQline <- qqline(R)
hist(R, xlab="Residuals", main ="")
plot(Site, R, xlab="Site", ylab="Residuals")
plot(Habitat, R, xlab="Habitat", ylab="Residuals")

shapiro <- shapiro.test(R) #runs a normality test on residuals
shapiro # null = normally distrubuted (P<0.05 = non-normal)

# Model
mod<-lm(coral.pigmented~Site*Habitat, data=df); summary(mod)
Anova(mod, type=3)

################
# bleached coral
################
hist(df$coral.bleached)

mod<-lm(coral.bleached~Site*Habitat, data=df)

R <- resid(mod) #save glm residuals
op<-par(mfrow = c(2,2), mar=c(5,4,1,2))
plot(mod, add.smooth = FALSE, which=1)
QQ <- qqnorm(R, main = "") 
QQline <- qqline(R)
hist(R, xlab="Residuals", main ="")
plot(Site, R, xlab="Site", ylab="Residuals")
plot(Habitat, R, xlab="Habitat", ylab="Residuals")

shapiro <- shapiro.test(R) #runs a normality test on residuals
shapiro # null = normally distrubuted (P<0.05 = non-normal)

# Models
mod<-lm(coral.bleached~Site*Habitat, data=df); summary(mod)
Anova(mod, type=3)

#######################
# completely white coral
#######################
hist(df$coral.white)

mod<-lm(coral.white~Site*Habitat, data=df)

R <- resid(mod) #save glm residuals
op<-par(mfrow = c(2,2), mar=c(5,4,1,2))
plot(mod, add.smooth = FALSE, which=1)
QQ <- qqnorm(R, main = "") 
QQline <- qqline(R)
hist(R, xlab="Residuals", main ="")
plot(Site, R, xlab="Site", ylab="Residuals")
plot(Habitat, R, xlab="Habitat", ylab="Residuals")

shapiro <- shapiro.test(R) #runs a normality test on residuals
shapiro # null = normally distrubuted (P<0.05 = non-normal)

# Models
mod<-lm(coral.white~Site*Habitat, data=df); summary(mod)
Anova(mod, type=3)

#
#####
##########
##############
####################
# MONTIPORA CAPITATA BLEACHING
####################
###############
##########
#####
#

################
# pigmented MC
################
hist(df$MC.pigmented)

mod<-lm(MC.pigmented~Site*Habitat, data=df)

R <- resid(mod) #save glm residuals
op<-par(mfrow = c(2,2), mar=c(5,4,1,2))
plot(mod, add.smooth = FALSE, which=1)
QQ <- qqnorm(R, main = "") 
QQline <- qqline(R)
hist(R, xlab="Residuals", main ="")
plot(Site, R, xlab="Site", ylab="Residuals")
plot(Habitat, R, xlab="Habitat", ylab="Residuals")


shapiro <- shapiro.test(R) #runs a normality test on residuals
shapiro # null = normally distrubuted (P<0.05 = non-normal)

# Model
mod<-lm(MC.pigmented~Site*Habitat, data=df); summary(mod)
Anova(mod, type=3)

################
# bleached MC
################
hist(df$MC.bleached)

mod<-lm(MC.bleached~Site*Habitat, data=df)

R <- resid(mod) #save glm residuals
op<-par(mfrow = c(2,2), mar=c(5,4,1,2))
plot(mod, add.smooth = FALSE, which=1)
QQ <- qqnorm(R, main = "") 
QQline <- qqline(R)
hist(R, xlab="Residuals", main ="")

shapiro <- shapiro.test(R) #runs a normality test on residuals
shapiro # null = normally distrubuted (P<0.05 = non-normal)

# Models
mod<-lm(MC.bleached~Site*Habitat, data=df); summary(mod)
Anova(mod, type=3)

#######################
# completely white MC
#######################
hist(df$MC.white)

mod<-lm(MC.white~Site*Habitat, data=df)

R <- resid(mod) #save glm residuals
op<-par(mfrow = c(2,2), mar=c(5,4,1,2))
plot(mod, add.smooth = FALSE, which=1)
QQ <- qqnorm(R, main = "") 
QQline <- qqline(R)
hist(R, xlab="Residuals", main ="")

shapiro <- shapiro.test(R) #runs a normality test on residuals
shapiro # null = normally distrubuted (P<0.05 = non-normal)

# Models
mod<-lm(MC.white~Site*Habitat, data=df); summary(mod)
Anova(mod, type=3)
```


## Physiology-Immunity  
  
*Import data and normalize*  
Raw data from physiological assessments is imported and normalized according to established protocols. Immunolgical data has been normalized previously and is represented as the final dataframe.

```{r}
###########################################################################
## data period: October 2014, February 2015, October 2015, February 2016 ##
###########################################################################

### data file
# all lab data from all time points (physio and immuno, PLUS color analysis)
physimmun<-read.csv("data/Gates_Mydlarz_20142016_physimmun.csv", header=T, na.string=NA) #physimmuno data
qPCR.data<-read.csv("data/Gates_Mydlarz_20142016_qPCR.csv", header=T, na.string=NA) #qPCR data

data<-read.csv("data/Gates_Mydlarz_20142016_ALL_DATA.csv", header=T, na.string=NA) #qPCR data


################################################
# PHYSIOLOGY: calculate, normalize dependent variables
################################################
data$cells..ml<-as.numeric(data$cells..ml)
data$ID<-as.factor(data$ID)


# helpful shorthand
SA<-data$surface.area.cm2 # surface area in cm2
blastate<-data$total.blastate.ml # tissue slurry blastate in ml

# Symbiodinium.cells..cm2 == cell.ml * blastate / SA
data$zoox<- (data$cells..ml*blastate)/SA

# ug.chlorophyll.a..cm2 == ug.chl.a.ml * blastate / SA
data$chla<- (data$ug.chla..ml*blastate)/SA

# pg.chlorophyll.a..cell == ug.chl.a.ml * 10^6 / cells.ml
data$chlacell<- (data$ug.chla..ml*10^6)/data$cells..ml

# AFDW.mg..cm2 == convert AFDW g to mg, mutiply by blastate volume, divide by cm2
data$AFDW<- (data$g.AFDW..ml*1000*blastate)/SA

# mg.protein..cm2 == mg.protein.ml * blastate / SA
data$prot<- (data$mg.prot..ml*blastate)/SA


#### rearrange and clean up

# drop unwanted columns by name
data<-data[!colnames(data) %in% c("total.blastate.ml", "surface.area.cm2", "mg.prot..ml", "cells..ml", "ug.chla..ml", "g.AFDW..ml")]

data<-data[!(data$ID=="N37"), ] # this coral has an NA for symbiont type, remove from df

# reorder columns to show: hierarchy of structure, physio., immuno., colorimetry
# this is now the working dataframe
df<-data[, c(1:6, 20:24, 7:19)]

# remove negative values for MEL and POX and
df$MEL[df$MEL <= 0]<- NA
df$MEL[df$MEL > 0.05]<- NA

df$POX[df$POX <= 0]<- NA
df$CAT[df$CAT <= 0]<- NA
df$PPO[df$PPO <= 0]<- NA


df$chlacell[df$chlacell >= 10]<- NA # removing 2 outliers
df$CAT[df$CAT >= 900]<- NA # 2 outliers removed


# don't need "Ramp" lab data, this was lab thermally stressed. Remove this.
df<-df[!(df$Status=="Lab-Ramp"),]

#write.csv(df, "df.normalized.csv")
```

```{r, fig.width= 2, fig.height= 2, eval=FALSE}

## Color scores

#Overall, color is a poor measure of bleaching in these fragments, and there is not a strong relationship between color (R/G/B) and physiological bleaching quantification. Issues may be in the approach to get color scores (in shooting images, or downstream in photoshop), as well as in the fact the same color score can represent significant changes in cell density or chla content thereby making the relationship noisy (although significant).  

#red and green are best explantory variable for chla (~25 % R2)  
#blue and green slightly better to explain zoox density (~33 % R2)  

# par(mfrow=c(1,3), mar=c(5,4,1,2), pty="sq")

##########################################
# testing color scores and chla relationship
mod<-lm(coral.red.adj~chla, data=df)
plot(coral.red.adj~chla, data=df)
abline(mod, col="red")

mod<-lm(coral.blue.adj~chla, data=df)
plot(coral.blue.adj~chla, data=df)
abline(mod, col="blue")

mod<-lm(coral.green.adj~chla, data=df)
plot(coral.green.adj~chla, data=df)
abline(mod, col="green")


### Color score by *Symbiodinium* cells cm-2
##########################################
# testing color score and zoox relationship
mod<-lm(coral.red.adj~zoox, data=df)
plot(coral.red.adj~zoox, data=df)
abline(mod, col="red")

mod<-lm(coral.blue.adj~zoox, data=df)
plot(coral.blue.adj~zoox, data=df)
abline(mod, col="blue")

mod<-lm(coral.green.adj~zoox, data=df)
plot(coral.green.adj~zoox, data=df)
abline(mod, col="green")


####### PCA and color score
####### Run the PCA first and save PC1 data 

pca.df<-(df[-c(1:113),c(2:6, 17:19)]) # all data with only "Event" and "Site" as categories
colnames(pca.df)<-c("Period", "Status", "Site", "Status_Site", "ID", "red", "green", "blue")
pca.df<-pca.df[-9, ] #remove NA row

# apply PCA - scale. = TRUE for center as advised
PC <- prcomp(pca.df[, 6:8], center = TRUE, scale.= TRUE)  

#correlatin matrix helps to standardize the data and account for different scales
# print(PC) # to print PC loadings

# summary(PC) #signficance of PCs: proportion of variance captured, cumulative variance
# plot(PC, type="lines") will plot PCs

newdat<-PC$x[,1:3]; # newdata frame with only PCs 
# PC1 explain ~>82% of variance

# save the file of PCs
write.csv(newdat, "PC1-allcolors_alltimes.csv")

# the SDEV^2 is the eignevalue
ev<-PC$sdev^2 # PC1-3 have eignevalues >1
# ev/sum(ev) # to give proportional eignevalues

#########
# plot it as PCA analysis by bleaching period

## PC1 and PC2
g <- ggbiplot(PC, choices = 1:2, obs.scale = 1, var.scale = 1, 
              groups= pca.df[,1], ellipse = TRUE, 
              circle = FALSE) +
              scale_color_discrete(name = '') +
  theme_bw() +
  theme(legend.text=element_text(size=15)) +
  theme(panel.background = element_rect(colour = "black", size=1))+
  theme(legend.key = element_blank())+
  theme(legend.direction = 'horizontal', legend.position = 'top') +theme(aspect.ratio=0.7)
print(g)

##################

### graphing the PC1 color score relationship with chlorophyll or *Symbiodinium* density**
### significant relationships, but only 27% (chla) and 35% (zoox) of variance explained

##########################################
# testing color scores and chla relationship
mod<-lm(PC1~chla, data=df)
plot(PC1~chla, data=df)
abline(mod, col="mediumorchid3")

##########################################
# testing PC1 score and zoox relationship
mod<-lm(PC1~zoox, data=df)
plot(PC1~zoox, data=df)
abline(mod, col="mediumorchid")



### Categorical binning for bleaching
# First, looked at all the data as histograms of chlorophyll a and zoox density across all 4 time periods. Second, looked at the histograms forjust bleaching, and then just recovery periods. While it is difficult to say when a coral is truly bleached, a conservative measure of < 3 ug chla/cm2 or < 1.5 million cells may be used as a relative measure of bleaching.


#############################
# all data: bleaching and recovery periods
par(mfrow=c(1,2), mar=c(5,4,1,2), pty="sq")
hist(df$zoox, main="all time points"); hist(df$chla, main="all time points")


#############################
#### just "bleaching" periods
bleaching.df<-df[df$Status=="Bleaching", ]

par(mfrow=c(1,2), mar=c(5,4,1,2), pty="sq")
hist(bleaching.df$zoox, main="bleaching periods")
hist(bleaching.df$chla, main="bleaching periods") 
# less than 3 ug chla/cm2 is good indication of "bleached"
# less than 1.5 million cells/cm2 is good indication of "bleached

# what about symbiont community
hist(bleaching.df[bleaching.df$dom=="D",]$chla)
hist(bleaching.df[bleaching.df$dom=="C",]$chla)


#############################
#### just "recovery" periods
recovery.df<-df[df$Status=="Recovery", ]

par(mfrow=c(1,2), mar=c(5,4,1,2), pty="sq")
hist(recovery.df$zoox, main="recovery periods")
hist(recovery.df$chla,  main="recovery periods")

### Bleaching categories
# Decided to bin the data based on bleaching (< 40%  ug chla cm-2) and pigmented (> 60% ug chla cm-2). This should help in finding those corals more affected by the thermal stress, and those not affected as severely.

#### applying binning

#### no break here for Lab 2014--these are all effectively field controls for physiology
Field.2014<-df[(df$Period=="2014 Field.Feb"),]
Field.2014<- Field.2014 %>% mutate(
            bleach.category = "Field-Pre")

#### no break here for Lab 2014--these are all effectively field controls for physiology
Lab.2014<-df[(df$Period=="2014 Lab"),]
quantile(Lab.2014$chla, 0.4, na.rm=TRUE) # = 3.86
Lab.2014<- Lab.2014 %>% mutate(
            bleach.category = "Lab-pigmented")

#### 40% quantile for October 2014
Oct.2014<-df[(df$Period=="2014 Oct"),]
quantile(Oct.2014$chla, 0.4, na.rm=TRUE) # = 2.97
Oct.2014<- Oct.2014 %>% mutate(
            bleach.category = ifelse(chla < "2.97", "pale", "pigmented"))

#### 40% quantile for February 2015
Feb.2015<-df[(df$Period=="2015 Feb"),]
quantile(Feb.2015$chla, 0.4, na.rm=TRUE) # = 3.72
Feb.2015<- Feb.2015 %>% mutate(
            bleach.category = ifelse(chla < "3.72", "pale", "pigmented"))

#### 40% quantile for October 2015
Oct.2015<-df[(df$Period=="2015 Oct"),]
quantile(Oct.2015$chla, 0.4, na.rm=TRUE)  # = 2.49
Oct.2015<- Oct.2015 %>% mutate(
            bleach.category = ifelse(chla < "2.49", "pale", "pigmented"))

#### 40% quantile for January 2016
Feb.2016<-df[(df$Period=="2016 Feb"),]
quantile(Feb.2016$chla, 0.4, na.rm=TRUE)  # = 3.84
Feb.2016<- Feb.2016 %>% mutate(
            bleach.category = ifelse(chla < "3.84", "pale", "pigmented"))


##########
## Now combine all the dataframes above back into a single df
df<-rbind(Field.2014, Lab.2014, Oct.2014, Feb.2015, Oct.2015, Feb.2016)

```

### Summary dataframes
These dataframes show mean, SE and n for each group. This can be subset to make figures or exported as a summary file. The header of the dataframe is shown below...

```{r, echo=FALSE}
# make summary dataframes

# dataframes of means can later be divided into categories by "C or D" dominated

###------#### means

# physiology
zoox.m<-aggregate(zoox~Site+Status+Period+dom,data=df, mean)
chla.m<-aggregate(chla~Site+Status+Period+dom,data=df, mean)
chlacell.m<-aggregate(chlacell~Site+Status+Period+dom, data=df, mean)
prot.m<-aggregate(prot~Site+Status+Period+dom, data=df, mean)
AFDW.m<-aggregate(AFDW~Site+Status+Period+dom, data=df, mean)

# imunology
CAT.m<-aggregate(CAT~Site+Status+Period+dom,data=df, mean)
POX.m<-aggregate(POX~Site+Status+Period+dom,data=df, mean)
SOD.m<-aggregate(SOD~Site+Status+Period+dom,data=df, mean)
PPO.m<-aggregate(PPO~Site+Status+Period+dom,data=df, mean)
MEL.m<-aggregate(MEL~Site+Status+Period+dom,data=df, mean)

###------#### SE
# physiology
zoox.SE<-aggregate(zoox~Site+Status+Period+dom,data=df, std.error)
chla.SE<-aggregate(chla~Site+Status+Period+dom,data=df, std.error)
chlacell.SE<-aggregate(chlacell~Site+Status+Period+dom, data=df, std.error)
prot.SE<-aggregate(prot~Site+Status+Period+dom, data=df, std.error)
AFDW.SE<-aggregate(AFDW~Site+Status+Period+dom, data=df, std.error)

# imunology
CAT.SE<-aggregate(CAT~Site+Status+Period+dom,data=df, std.error)
POX.SE<-aggregate(POX~Site+Status+Period+dom,data=df, std.error)
SOD.SE<-aggregate(SOD~Site+Status+Period+dom,data=df, std.error)
PPO.SE<-aggregate(PPO~Site+Status+Period+dom,data=df, std.error)
MEL.SE<-aggregate(MEL~Site+Status+Period+dom,data=df, std.error)

###------#### n-value
# physiology
zoox.n<-aggregate(zoox~Site+Status+Period+dom,data=df, length)
chla.n<-aggregate(chla~Site+Status+Period+dom,data=df, length)
chlacell.n<-aggregate(chlacell~Site+Status+Period+dom, data=df, length)
prot.n<-aggregate(prot~Site+Status+Period+dom, data=df, length)
AFDW.n<-aggregate(AFDW~Site+Status+Period+dom, data=df, length)

# imunology
CAT.n<-aggregate(CAT~Site+Status+Period+dom,data=df, length)
POX.n<-aggregate(POX~Site+Status+Period+dom,data=df, length)
SOD.n<-aggregate(SOD~Site+Status+Period+dom,data=df, length)
PPO.n<-aggregate(PPO~Site+Status+Period+dom,data=df, length)
MEL.n<-aggregate(MEL~Site+Status+Period+dom,data=df, length)


#### physio dataframe
fig.df.phys<-cbind(zoox.m, zoox.SE[c(5,0)],chla.m[c(5,0)], chla.SE[c(5,0)], chlacell.m[c(5,0)], chlacell.SE[c(5,0)], prot.m[c(5,0)], prot.SE[c(5,0)], AFDW.m[c(5,0)], AFDW.SE[c(5,0)], chla.n[c(5,0)])

colnames(fig.df.phys)<-c("Site","Status", "Period", "dom", "zoox", "zoox.SE", "chla", "chla.SE", "chlacell", "chlacell.SE", "prot", "prot.SE", "AFDW", "AFDW.SE", "N-chla")

# make an interaction column
fig.df.phys$int<-interaction(fig.df.phys$Site, fig.df.phys$dom)
fig.df.phys$int<-factor(fig.df.phys$int)
####


#### immuno dataframe
fig.df.immuno<-cbind(CAT.m, CAT.SE[c(5,0)], POX.m[c(5,0)], POX.SE[c(5,0)], SOD.m[c(5,0)], SOD.SE[c(5,0)], PPO.m[c(5,0)], PPO.SE[c(5,0)], MEL.m[c(5,0)], MEL.SE[c(5,0)])

colnames(fig.df.immuno)<-c("Site","Status", "Period", "dom", "CAT", "CAT.SE", "POX", "POX.SE", "SOD", "SOD.SE", "PPO", "PPO.SE", "MEL", "MEL.SE")

# make an interaction column
fig.df.immuno$int<-interaction(fig.df.immuno$Site, fig.df.immuno$dom)
fig.df.immuno$int<-factor(fig.df.immuno$int)

# write.csv(xxx, "Figure.df.xxx.csv")
```

## Figures

```{r}
# side by side figures separated by Sites 
### Physiological figures

color.scheme<-c("gray80", "gray60", 'lightskyblue', 'dodgerblue', 
                "gray50", "gray30", "thistle", "coral")
break.points<-c("Lilipuna.Pre.C", "Lilipuna.Pre.D", "Lilipuna.C", "Lilipuna.D", 
                "Reef 14.Pre.C", "Reef 14.Pre.D", "Reef 14.C", "Reef 14.D")
legend.names<-c("Lil.Pre C", "Lil.Pre D", "Lil C", "Lil D", 
                "R14.Pre C", "R14.Pre D", "R14 C", "R14 D")
axis.labels<-c("Feb 2014 \nPre-Bleaching", "Oct 2014 \nBleaching","Feb 2015 \nRecovery","Oct 2015 \nBleaching", "Feb 2016 \nRecovery")


Fig.formatting<-(theme_classic()) +
  theme(text=element_text(size=6),
  axis.line=element_blank(),
  legend.text.align = 0,
  legend.text=element_text(size=5),
    #legend.title = element_blank(),
      panel.border = element_rect(fill=NA, colour = "black", size=1),
      aspect.ratio=1, 
    axis.ticks.length=unit(0.2, "cm"),
    axis.text.y=element_text(
      margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=6), 
    axis.text.x=element_text(
      margin=unit(c(0.5, 0.5, 0.5, 0.5), "cm"), colour="black", size=6)) +
  theme(legend.key.size = unit(0.4, "cm")) +
  theme(aspect.ratio=1) +
  theme(panel.spacing=unit(c(0, 0, 0, 0), "cm"))


pd <- position_dodge(0.15) #offset for error bars


########################
#### graph as category of C/D
######################## 

fig.df.phys$int<-factor(fig.df.phys$int, levels=c("Lilipuna.Pre.C", "Lilipuna.Pre.D", "Lilipuna.C", "Lilipuna.D", "Reef 14.Pre.C", "Reef 14.Pre.D", "Reef 14.C", "Reef 14.D"))
```

**Symbiodinium cm-2**
```{r}
###################
# zoox 
zoox.fig<-ggplot(data=fig.df.phys, aes(x=Period, y=zoox/10^6, group=int, color=int)) + geom_errorbar(aes(ymin=zoox/10^6-zoox.SE/10^6, ymax=zoox/10^6+zoox.SE/10^6), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1, pch=19) +
  coord_cartesian(ylim=c(0, 3)) +
  ylab(expression(paste(~italic("Symbiodinium") ~(10^6~cells~cm^-2), sep=""))) +
  scale_color_manual(values=c(color.scheme),
                     name= "Site:Clade",
                     breaks=break.points,
                     labels=legend.names) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting

zoox.fig

```

**Chlorophyll *a* cm-2**
```{r}
########## chla cm2 ############
chla.fig<-ggplot(data=fig.df.phys, aes(x=Period, y=chla, group=int, color=int)) + geom_errorbar(aes(ymin=chla-chla.SE, ymax=chla+chla.SE), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1) +
  coord_cartesian(ylim=c(0, 8)) +
  ylab(expression(paste("Chlorophyll", ~italic("a"), ~(mu*g~cm^-2), sep=""))) +
  scale_color_manual(values=c(color.scheme),
                     name= "Site:Clade",
                     breaks=break.points,
                     labels=legend.names) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting
chla.fig
```

**Chlorophyll *a* cell-1**
```{r, message=FALSE}
########## chla cell ############
chlacell.fig<-ggplot(data=fig.df.phys, aes(x=Period, y=chlacell, group=int, color=int)) + geom_errorbar(aes(ymin=chlacell-chlacell.SE, ymax=chlacell+chlacell.SE), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1) +
  coord_cartesian(ylim=c(0, 8)) +
  ylab(expression(paste("Chlorophyll", ~italic("a"), ~(pg~cell^-1), sep=""))) +
  scale_color_manual(values=c(color.scheme),
                     name= "Site:Clade",
                     breaks=break.points,
                     labels=legend.names) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting
chlacell.fig
```

**Protein biomass cm-2**
```{r}

########## protein ############
prot.fig<-ggplot(data=fig.df.phys, aes(x=Period, y=prot, group=int, color=int)) + geom_errorbar(aes(ymin=prot-prot.SE, ymax=prot+prot.SE), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1) +
  coord_cartesian(ylim=c(0, 1)) +
  ylab(expression(paste("Protein", ~(mg~cm^-2), sep=""))) +
  scale_color_manual(values=c(color.scheme),
                     name= "Site:Clade",
                     breaks=break.points,
                     labels=legend.names) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting
prot.fig
```

**Total biomass (AFDW) cm-2**
```{r}

########## AFDW ############
AFDW.fig<-ggplot(data=fig.df.phys, aes(x=Period, y=AFDW, group=int, color=int)) + geom_errorbar(aes(ymin=AFDW-AFDW.SE, ymax=AFDW+AFDW.SE), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1) +
  coord_cartesian(ylim=c(0, 60)) +
  ylab(expression(paste("Total biomass", ~(mg~cm^-2), sep=""))) +
  scale_color_manual(values=c(color.scheme),
                     name= "Site:Clade",
                     breaks=break.points,
                     labels=legend.names) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting
AFDW.fig
```

### Imunological figures

**Prophenoloxidase (PPO)**
```{r}
#names(fig.df.immuno)

# site means
CAT.m2<-aggregate(CAT~Site+Status+Period,data=df, mean)
POX.m2<-aggregate(POX~Site+Status+Period,data=df, mean)
SOD.m2<-aggregate(SOD~Site+Status+Period,data=df, mean)
PPO.m2<-aggregate(PPO~Site+Status+Period,data=df, mean)
MEL.m2<-aggregate(MEL~Site+Status+Period,data=df, mean)

###------#### SE
# imunology
CAT.SE2<-aggregate(CAT~Site+Status+Period,data=df, std.error)
POX.SE2<-aggregate(POX~Site+Status+Period,data=df, std.error)
SOD.SE2<-aggregate(SOD~Site+Status+Period,data=df, std.error)
PPO.SE2<-aggregate(PPO~Site+Status+Period,data=df, std.error)
MEL.SE2<-aggregate(MEL~Site+Status+Period,data=df, std.error)

immuno.site.df<-cbind(CAT.m2, CAT.SE2[c(4,0)], POX.m2[c(4,0)], POX.SE2[c(4,0)], SOD.m2[c(4,0)], SOD.SE2[c(4,0)], PPO.m2[c(4,0)], PPO.SE2[c(4,0)], MEL.m2[c(4,0)], MEL.SE2[c(4,0)])

colnames(immuno.site.df)<-c("Site","Status", "Period", "CAT", "CAT.SE", "POX", "POX.SE", "SOD", "SOD.SE", "PPO", "PPO.SE", "MEL", "MEL.SE")

Pre.immuno<-immuno.site.df[c(1:2),]
Pre.immuno$dom<-"unident"
Pre.immuno<-Pre.immuno[, c(1:3, 14, 4:13)]
Pre.immuno$int<-interaction(Pre.immuno$Site, Pre.immuno$dom)

## now this subset of site means can be overlayed with datafame from Oct 2014- Feb 2016
fig.df.immuno.comp<-rbind(Pre.immuno, fig.df.immuno)


color.scheme2<-c("gray70", 'lightskyblue', 'dodgerblue', 
                "gray40", "thistle", "coral")
break.points.immuno<-c("Lilipuna.Pre.unident", "Lilipuna.C", "Lilipuna.D", 
                "Reef 14.Pre.unident", "Reef 14.C", "Reef 14.D")
legend.names.immuno<-c("Lil.Pre unident.", "Lil C", "Lil D", 
                "R14.Pre unident.", "R14 C", "R14 D")


fig.df.immuno.comp$int<-factor(fig.df.immuno.comp$int, levels=c("Lilipuna.Pre.unident","Lilipuna.C", "Lilipuna.D", "Reef 14.Pre.unident", "Reef 14.C", "Reef 14.D"))


########## Prophenoloxidase (PPO) ############
PPO.fig<-ggplot(data=fig.df.immuno.comp, aes(x=Period, y=PPO, group=int, color=int)) + geom_errorbar(aes(ymin=PPO-PPO.SE, ymax=PPO+PPO.SE), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1) +
  coord_cartesian(ylim=c(0, 3)) +
  ylab(expression(paste("PO Activity", ~(Delta~Abs~"490nm"~min^-1~mg~prot^-1), sep=""))) +
  scale_color_manual(values=c(color.scheme2),
                     name= "Site:Clade",
                     breaks=break.points.immuno,
                     labels=legend.names.immuno) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting
PPO.fig
```

**Melanin (MEL)**
```{r}
MEL.lab<-aggregate(MEL~Site+Status+Period,data=data, mean)
MEL.labSE<-aggregate(MEL~Site+Status+Period,data=data, std.error)
MEL.df<-cbind(MEL.lab, MEL.labSE[c(4,0)]); colnames(MEL.df[,4:5])<-c("MEL", "MEL.labSE")
MEL.df$Period<-factor(MEL.df$Period, levels=c("2014 Field.Feb", "2014 Lab", "2014 Oct", "2015 Feb", "2015 Oct", "2016 Feb"))

#plot(MEL~Period, data=MEL.df, cex.axis=0.8)
#dev.copy(pdf,"Figures/MEL.all.time.pdf", height=5, width=7, encod="MacRoman")
#dev.off

######## Melanin (MEL) #############
MEL.fig<-ggplot(data=fig.df.immuno.comp, aes(x=Period, y=MEL, group=int, color=int)) + geom_errorbar(aes(ymin=MEL-MEL.SE, ymax=MEL+MEL.SE), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1) +
  coord_cartesian(ylim=c(0, 0.02)) +
  ylab(expression(paste("MEL", ~(Abs~"490nm"~mg~tissue^-1), sep="")))+
  scale_color_manual(values=c(color.scheme2),
                     name= "Site:Clade",
                     breaks=break.points.immuno,
                     labels=legend.names.immuno) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting
MEL.fig

#ggsave("Figures/MEL.field.pdf", height=5, width=7, encod="MacRoman")
```

**Peroxidase (POX)**
```{r}

########## Peroxidase (POX) ##############
POX.fig<-ggplot(data=fig.df.immuno.comp, aes(x=Period, y=POX, group=int, color=int)) + geom_errorbar(aes(ymin=POX-POX.SE, ymax=POX+POX.SE), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1) +
  coord_cartesian(ylim=c(0, 1.5)) +
  ylab(expression(paste("POX activity", ~(Delta~Abs~"470nm"~min^-1~mg~prot^-1), sep=""))) +
  scale_color_manual(values=c(color.scheme2),
                     name= "Site:Clade",
                     breaks=break.points.immuno,
                     labels=legend.names.immuno) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting
POX.fig
```

**Catalase (CAT)**
```{r}

###### Catalase (CAT) ########
CAT.fig<-ggplot(data=fig.df.immuno.comp, aes(x=Period, y=CAT, group=int, color=int)) + geom_errorbar(aes(ymin=CAT-CAT.SE, ymax=CAT+CAT.SE), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1) +
  coord_cartesian(ylim=c(0, 800)) +
  ylab(expression(paste("CAT activity", ~(Abs~"490nm"~mg~tissue^-1), sep="")))+
  scale_color_manual(values=c(color.scheme2),
                     name= "Site:Clade",
                     breaks=break.points.immuno,
                     labels=legend.names.immuno) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting
CAT.fig
```

**Superoxide dismutase (SOD)**
```{r, message=FALSE, warning=FALSE}

######### Superoxide dismutase (SOD) ########
SOD.fig<-ggplot(data=fig.df.immuno.comp, aes(x=Period, y=SOD/10^3, group=int, color=int)) + geom_errorbar(aes(ymin=SOD/10^3-SOD.SE/10^3, ymax=SOD/10^3+SOD.SE/10^3), size=.6, width=0, position=pd) +
  geom_line(position=pd, size=.6) +
  geom_point(position=pd, size=1) +
  coord_cartesian(ylim=c(0, 50)) +
  ylab(expression(paste("SOD activity", ~x10^3~mg~protein^-1, sep=""))) +
  scale_color_manual(values=c(color.scheme2),
                     name= "Site:Clade",
                     breaks=break.points.immuno,
                     labels=legend.names.immuno) +
  scale_x_discrete(name ="Year and Event", 
      labels=axis.labels)+
  Fig.formatting
SOD.fig
```
```{r, univariate figures}

# legend plot
fig.legend<-ggplot(data=fig.df.immuno.comp, aes(x=Period, y=SOD, group=int, color=int)) +
  geom_point(position=pd, size=3) +
  coord_cartesian(ylim=c(0, 1)) +
  scale_color_manual(values=c(color.scheme2),
                     name= "Site:Clade",
                     breaks=break.points.immuno,
                     labels=legend.names.immuno) +
  theme_void()
fig.legend

Phys.figs<-plot_grid( (zoox.fig + theme(legend.position = "none")), 
           (chla.fig + theme(legend.position = "none")),
           (chlacell.fig + theme(legend.position = "none")), 
           (prot.fig+ theme(legend.position = "none")),
           (AFDW.fig+ theme(legend.position = "none")),
           fig.legend,
          labels = c("a", "b", "c", "d", "e",""), ncol = 3)
Phys.figs
dev.copy(pdf, "figures/Phys.figs.pdf", encod="MacRoman", height=5, width=8)
dev.off()

Immuno.figs<-plot_grid( (MEL.fig + theme(legend.position = "none")),
           (PPO.fig + theme(legend.position = "none")), 
           (POX.fig+ theme(legend.position = "none")),
           (CAT.fig+ theme(legend.position = "none")),
           SOD.fig + theme(legend.position = "none"),
           fig.legend,
          labels = c("a", "b", "c", "d", "e",""), ncol = 3)
Immuno.figs
dev.copy(pdf, "figures/Immuno.figs.pdf", encod="MacRoman", height=5, width=8)
dev.off()

```



###Models  

Running models of response variables. First check for assumptions of ANOVA and apply transformations where necessary.  
  
*lm(Y~Period x Site x dom, data=model.data, na.action=na.exclude)*  
*Period* is the 4 events, *Site* is the two reefs, *dom* is the symbiont community (C- or D-dominated)

```{r, include=FALSE}
#df ## this is the data

model.data<-df[ , !(names(df) %in% c("coral.red.adj","coral.green.adj", "coral.blue.adj", "PC1", "propC", "propD", "syms"))] # remove unwanted columns

model.data<-model.data[!c(model.data$Period=="2014 Lab"),] 
model.data<-model.data[!c(model.data$Period=="2014 Field.Feb"),] # drop data prior to Oct 2014 bleaching

model.data$Period<-factor(model.data$Period) #re-call as factor to remove dropped levels
model.data$Status<-factor(model.data$Status)


for(i in c(7:9, 11:16)){
  Y<-model.data[,i]
  full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
  R <- resid(full) #save glm residuals
  
  op<-par(mfrow = c(2,2), mar=c(5,4,1,2), pty="sq")
  plot(full, add.smooth = FALSE, which=1)
  QQ <- qqnorm(R, main = colnames(model.data)[i]) 
  QQline <- qqline(R)
  hist(R, xlab="Residuals", main = colnames(model.data)[i])
}

# need BoxCox transformation for most immuno data
Yx<-(model.data$AFDW) 

### test with transformations
boxcox(Yx~Period*Site*dom, data=model.data, lambda=seq(-0.25, 1, length=10))
### test residuals, histogram, QQ
full<-lm(Yx~Period*Site*dom, data=model.data, na.action=na.exclude)
  R <- resid(full) #save glm residuals
  op<-par(mfrow = c(2,2), mar=c(5,4,1,2), pty="sq")
  plot(full, add.smooth = FALSE, which=1)
  QQ <- qqnorm(R) 
  QQline <- qqline(R)
  hist(R, xlab="Residuals")

##### revised model.data (below are data needing transformations)
model.data$CAT<-(model.data$CAT)^0.5
model.data$POX<-(model.data$POX)^0.25
model.data$PPO<-(model.data$PPO) ^0.25
model.data$MEL<-(model.data$MEL)^0.25

## dataframe 'model.data' now ready for full model analysis
```

Run linear models for response variables  

**Symbiodinium cm-2**
```{r symbiont model, warning=FALSE, message=FALSE}
# symbionts ---- 
Y<-model.data$zoox
full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
#summary(full)
print(Anova(full, type=2), digits=4)

posthoc<-lsmeans(full, ~Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~dom)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site|Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~dom|Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site*dom|Period)
cld(posthoc, Letters=letters)

plot(allEffects(full), ylab="zoox", par.strip.text=list(cex=0.7))
```

**Chlorophyll *a* cm^-2**
```{r chla model, warning=FALSE, message=FALSE}
# chla ---- 
Y<-model.data$chla
full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
#summary(full)
print(Anova(full, type=2), digits=4)

posthoc<-lsmeans(full, ~Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~dom|Period)
cld(posthoc, Letters=letters)
plot(allEffects(full), ylab="chla", par.strip.text=list(cex=0.7))
```

**chlorophyll *a* cell-1**
```{r chlcell model, warning=FALSE, message=FALSE}
# chlacell ---- 
Y<-model.data$chlacell
full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
##summary(full)
print(Anova(full, type=2), digits=4)

posthoc<-lsmeans(full, ~Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~dom)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~dom|Period)
cld(posthoc, Letters=letters)
plot(allEffects(full), ylab="AFDW", par.strip.text=list(cex=0.7))
```

**Protein cm-2**
```{r protein model, warning=FALSE, message=FALSE}
# prot ---- 
Y<-model.data$prot
full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
#summary(full)
print(Anova(full, type=2), digits=4)

posthoc<-lsmeans(full, ~dom)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site|Period)
cld(posthoc, Letters=letters)
plot(allEffects(full), ylab="prot", par.strip.text=list(cex=0.7))
```

**Catalase (CAT)**
```{r CAT Model, warning=FALSE, message=FALSE}
######################## 
### immunology
########################

# CAT ---- 
Y<-model.data$CAT
full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
#summary(full)
print(Anova(full, type=2), digits=4)

posthoc<-lsmeans(full, ~Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~dom)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site|Period)
cld(posthoc, Letters=letters)
plot(allEffects(full), ylab="CAT", par.strip.text=list(cex=0.7))
```

**Peroxidase (POX)**
```{r POX model, warning=FALSE, message=FALSE}
# POX ---- 
Y<-model.data$POX
full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
#summary(full)
print(Anova(full, type=2), digits=4)

posthoc<-lsmeans(full, ~Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~dom|Period)
cld(posthoc, Letters=letters)

plot(allEffects(full), ylab="POX", par.strip.text=list(cex=0.7))
```

**Superoxide dismutase (SOD)**
```{r SOD model, warning=FALSE, message=FALSE}
# SOD ---- 
Y<-model.data$SOD
full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
#summary(full)
print(Anova(full, type=2), digits=4)

posthoc<-lsmeans(full, ~Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site)
cld(posthoc, Letters=letters)

plot(allEffects(full), ylab="SOD", par.strip.text=list(cex=0.7))
```

**Prophenoloxidase (PPO)**
```{r PPO model, warning=FALSE, message=FALSE}
# PPO ---- 
Y<-model.data$PPO
full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
#summary(full)
print(Anova(full, type=2), digits=4)

posthoc<-lsmeans(full, ~Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~dom)
cld(posthoc, Letters=letters)
plot(allEffects(full), ylab="PPO", par.strip.text=list(cex=0.7))
```

**Melanin (MEL)**
```{r MEL model, warning=FALSE, message=FALSE}
# MEL ---- 
Y<-model.data$MEL
full<-lm(Y~Period*Site*dom, data=model.data, na.action=na.exclude)
#summary(full)
print(Anova(full, type=2), digits=4)

posthoc<-lsmeans(full, ~Period)
cld(posthoc, Letters=letters)

posthoc<-lsmeans(full, ~Site|Period)
cld(posthoc, Letters=letters)
plot(allEffects(full), ylab="prot", par.strip.text=list(cex=0.7))
```

```{r, MultiVariate, fig.show='hide', results='hide', message=FALSE}
# multivariate test using adonis-- Manova, mutivariate analysis of variance
library(devtools)
install_github("vqv/ggbiplot")
library(ggbiplot)
require(graphics)
library(tidyr)
library(vegan)
library(RVAideMemoire)

df.MV<-df

# remove columns unnecessary for final analysis, few factors retained
df.MV<-df.MV[ , !names(df.MV) %in% c("Species", "Status_Site", "ID", "coral.red.adj", "coral.green.adj", "coral.blue.adj", "PC1", "propC", "propD", "syms")]

# remove prior-to-bleaching timepoints and unused levels that arise from this action
df.MV<-df.MV[(!df.MV$Period=="2014 Lab"),] 
df.MV<-df.MV[(!df.MV$Period=="2014 Field.Feb"),]
df.MV$Period<-droplevels(df.MV$Period) 
df.MV$Status<-droplevels(df.MV$Status)

#drop all NAs, removing rows where NA was observed
df.MV.noNA<-df.MV %>% drop_na()


########## ########## ########## ########## ########## 
 ########## ########## ########## ########## ########## 
########## ########## ########## ########## ########## 

# for 4 panel NMDS separated by site and B-R periods
## build Manova dataframes 

########## Lilipuna 2014-2015
## Lilipuna only #######

## all data with lilupuna only
Manova.Lil.lev.dat<-df.MV.noNA %>% # "lev.dat" has levels and data
  filter(Site=="Lilipuna") 

# lilipuna bleaching-recovery1
Manova.Lil.BR1.lev.dat<-Manova.Lil.lev.dat %>% # "BR1" is bleaching and recovery 2014-2015
  filter(Period=="2014 Oct" | Period=="2015 Feb") 

# lilipuna bleaching-recovery2
Manova.Lil.BR2.lev.dat<-Manova.Lil.lev.dat %>% # "BR2" is bleachigng and recovery 2014-2015
  filter(Period=="2015 Oct" | Period=="2016 Feb") 

Manova.Lil.BR1.lev.dat$Period<-droplevels(Manova.Lil.BR1.lev.dat$Period)
Manova.Lil.BR1.lev.dat$Site<-droplevels(Manova.Lil.BR1.lev.dat$Site)

Manova.Lil.BR2.lev.dat$Period<-droplevels(Manova.Lil.BR2.lev.dat$Period)
Manova.Lil.BR2.lev.dat$Site<-droplevels(Manova.Lil.BR2.lev.dat$Site)

# BR1 just data (sans factors)
Manova.Lil.BR1.dat<-Manova.Lil.BR1.lev.dat %>% 
  select(-c(Period, Status, Site, dom)) #  sans factors

# BR2 just data (sans factors)
Manova.Lil.BR2.dat<-Manova.Lil.BR2.lev.dat %>% 
  select(-c(Period, Status, Site, dom)) #  sans factors


############################
############### 
##  Run BR1 2014-2015 MANOVA Lilipuna
MVA.Lilipuna.BR1<-adonis2(Manova.Lil.BR1.dat~Period*dom, data=Manova.Lil.BR1.lev.dat,permutations=1000, 
                method="bray", sqrt.dist = TRUE)

NMDS.Lil.BR1<-metaMDS(Manova.Lil.BR1.dat, distane='bray', k=2, trymax=100) 
stressplot(NMDS.Lil.BR1)

factor.df.Lil.BR1<-Manova.Lil.BR1.lev.dat %>% 
  select(c(Period, Site, Status, dom)) # get just the factors

NMDS.df.Lil.BR1<-data.frame(x=NMDS.Lil.BR1$point[,1], y=NMDS.Lil.BR1$point[,2], 
                    Period=as.factor(factor.df.Lil.BR1[,1]),
                    Site=as.factor(factor.df.Lil.BR1[,2]),
                    Status=as.factor(factor.df.Lil.BR1[,3]),
                    dom=as.factor(factor.df.Lil.BR1[,4]))

colnames(NMDS.df.Lil.BR1)[1:2]<-c("MDS1", "MDS2")

# vectors for variables
vars.Lil.BR1<-envfit(NMDS.Lil.BR1, Manova.Lil.BR1.dat, permu=999)
#scores(vars, "vectors")



#########################
########  Run 2015-2016 MANOVA Lilipuna
MVA.Lilipuna.BR2<-adonis2(Manova.Lil.BR2.dat~Period*dom, data=Manova.Lil.BR2.lev.dat,permutations=1000, 
                method="bray", sqrt.dist = TRUE)

NMDS.Lil.BR2<-metaMDS(Manova.Lil.BR2.dat, distane='bray', k=2, trymax=100) 
stressplot(NMDS.Lil.BR2)

factor.df.Lil.BR2<-Manova.Lil.BR2.lev.dat %>% 
  select(c(Period, Site, Status, dom)) # get just the factors

NMDS.df.Lil.BR2<-data.frame(x=NMDS.Lil.BR2$point[,1], y=NMDS.Lil.BR2$point[,2], 
                    Period=as.factor(factor.df.Lil.BR2[,1]),
                    Site=as.factor(factor.df.Lil.BR2[,2]),
                    Status=as.factor(factor.df.Lil.BR2[,3]),
                    dom=as.factor(factor.df.Lil.BR2[,4]))

colnames(NMDS.df.Lil.BR2)[1:2]<-c("MDS1", "MDS2")

# vectors for variables
vars.Lil.BR2<-envfit(NMDS.Lil.BR2, Manova.Lil.BR2.dat, permu=999)
#scores(vars, "vectors")


########## ########## ########## ########## 
########## Reef 14 2014-2015
## Reef 14 only #######

## all data with Reef14 only
Manova.R14.lev.dat<-df.MV.noNA %>% # "lev.dat" has levels and data
  filter(Site=="Reef 14") 

# Reef 14 bleaching-recovery1
Manova.R14.BR1.lev.dat<-Manova.R14.lev.dat %>% # "BR1" is bleachigng and recovery 2014-2015
  filter(Period=="2014 Oct" | Period=="2015 Feb") 

# Reef 14 bleaching-recovery2
Manova.R14.BR2.lev.dat<-Manova.R14.lev.dat %>% # "BR2" is bleachigng and recovery 2014-2015
  filter(Period=="2015 Oct" | Period=="2016 Feb") 

Manova.R14.BR1.lev.dat$Period<-droplevels(Manova.R14.BR1.lev.dat$Period)
Manova.R14.BR1.lev.dat$Site<-droplevels(Manova.R14.BR1.lev.dat$Site)

Manova.R14.BR2.lev.dat$Period<-droplevels(Manova.R14.BR2.lev.dat$Period)
Manova.R14.BR2.lev.dat$Site<-droplevels(Manova.R14.BR2.lev.dat$Site)

# BR1 just data (sans factors)
Manova.R14.BR1.dat<-Manova.R14.BR1.lev.dat %>% 
  select(-c(Period, Status, Site, dom)) #  sans factors

# BR2 just data (sans factors)
Manova.R14.BR2.dat<-Manova.R14.BR2.lev.dat %>% 
  select(-c(Period, Status, Site, dom)) #  sans factors


############################# 
############### 
##  Run BR1 2014-2015 MANOVA Reef 14
MVA.R14.BR1<-adonis2(Manova.R14.BR1.dat~Period*dom, data=Manova.R14.BR1.lev.dat,permutations=1000, 
                method="bray", sqrt.dist = TRUE)

NMDS.R14.BR1<-metaMDS(Manova.R14.BR1.dat, distane='bray', k=2, trymax=100) 
stressplot(NMDS.R14.BR1)

factor.df.R14.BR1<-Manova.R14.BR1.lev.dat %>% 
  select(c(Period, Site, Status, dom)) # get just the factors

NMDS.df.R14.BR1<-data.frame(x=NMDS.R14.BR1$point[,1], y=NMDS.R14.BR1$point[,2], 
                    Period=as.factor(factor.df.R14.BR1[,1]),
                    Site=as.factor(factor.df.R14.BR1[,2]),
                    Status=as.factor(factor.df.R14.BR1[,3]),
                    dom=as.factor(factor.df.R14.BR1[,4]))

colnames(NMDS.df.R14.BR1)[1:2]<-c("MDS1", "MDS2")

# vectors for variables
vars.R14.BR1<-envfit(NMDS.R14.BR1, Manova.R14.BR1.dat, permu=999)
#scores(vars, "vectors")



############################# 
########  Run 2015-2016 MANOVA R14
MVA.R14.BR2<-adonis2(Manova.R14.BR2.dat~Period*dom, data=Manova.R14.BR2.lev.dat,permutations=1000, 
                method="bray", sqrt.dist = TRUE)

NMDS.R14.BR2<-metaMDS(Manova.R14.BR2.dat, distane='bray', k=2, trymax=100) 
stressplot(NMDS.R14.BR2)

factor.df.R14.BR2<-Manova.R14.BR2.lev.dat %>% 
  select(c(Period, Site, Status, dom)) # get just the factors

NMDS.df.R14.BR2<-data.frame(x=NMDS.R14.BR2$point[,1], y=NMDS.R14.BR2$point[,2], 
                    Period=as.factor(factor.df.R14.BR2[,1]),
                    Site=as.factor(factor.df.R14.BR2[,2]),
                    Status=as.factor(factor.df.R14.BR2[,3]),
                    dom=as.factor(factor.df.R14.BR2[,4]))

colnames(NMDS.df.R14.BR2)[1:2]<-c("MDS1", "MDS2")

# vectors for variables
vars.R14.BR2<-envfit(NMDS.R14.BR2, Manova.R14.BR2.dat, permu=999)
#scores(vars, "vectors")
```

```{r, 4 panel NMDS plots}
# for exporting 4 panel plot
par(mfcol=c(2,2), mar=c(4,4,1,1))

###################################### plots
###################################### start with Lilipuna 2014-2015, then 2015-2016... then Reef 14

############### Lilipuna 2014-2015

MDS.levels<-levels(NMDS.df.Lil.BR1$Period:NMDS.df.Lil.BR1$dom)
MDS.lev.leg<-c("C-Bleach '14", "D-Bleach '14", "C-Recov '15", "D-Recov '15")
MDS.colors<-c("lightpink", "slategray1", "firebrick2", "dodgerblue2")

NMDS.plot<-ordiplot(NMDS.Lil.BR1, type="n", main=substitute(paste("Lilipuna-CRIMP-1")), cex.main=1, display="sites", cex.lab=0.8, cex.axis=0.8, ylim=c(-0.4, 0.4), xlim=c(-0.6, 0.5), xaxt="n", xlab="")
axis(side = 1, labels = FALSE, tck = -0.05)
abline(h = 0, lty = "dotted")
abline(v = 0, lty = "dotted")
points(NMDS.plot, "sites", cex=0.8, pch=16, col=MDS.colors)
ordiellipse(NMDS.plot, groups=NMDS.df.Lil.BR1$Period:NMDS.df.Lil.BR1$dom, draw="polygon", col=MDS.colors, alpha=150, kind="sd", conf=0.8)
legend("topright", legend=MDS.lev.leg, inset=c(0.59, -0.06), x.intersp=0.8, y.intersp=0.8, cex=0.7, pch=16, col=MDS.colors, pt.cex=1, bty="n")
par.new=T
plot(vars.Lil.BR1, col="black", p.max=0.05, cex=0.8, lwd=1)


############### Lilipuna 2015-2016

MDS.levels<-levels(NMDS.df.Lil.BR2$Period:NMDS.df.Lil.BR2$dom)
MDS.lev.leg<-c("C-Bleach '15", "D-Bleach '15", "C-Recov '16", "D-Recov '16")
MDS.colors<-c("lightpink", "slategray1", "firebrick2", "dodgerblue2")

NMDS.plot<-ordiplot(NMDS.Lil.BR2, type="n", cex.main=1, display="sites", cex.lab=0.8, cex.axis=0.8, ylim=c(-0.4, 0.4), xlim=c(-0.6, 0.5))
axis(side = 2, labels = FALSE, tck = -0.05)
abline(h = 0, lty = "dotted")
abline(v = 0, lty = "dotted")
points(NMDS.plot, "sites", cex=0.8, pch=16, col=MDS.colors)
ordiellipse(NMDS.plot, groups=NMDS.df.Lil.BR2$Period:NMDS.df.Lil.BR2$dom, draw="polygon", col=MDS.colors, alpha=150, kind="sd", conf=0.8)
legend("topright", legend=MDS.lev.leg, inset=c(0.59, -0.06), x.intersp=0.8, y.intersp=0.8, cex=0.7, pch=16, col=MDS.colors, pt.cex=1, bty="n")
par.new=T
plot(vars.Lil.BR2, col="black", p.max=0.05, cex=0.8, lwd=1)


############### ############### ############### ############### ############### 
############### Reef 14 2014-2015

MDS.levels<-levels(NMDS.df.R14.BR1$Period:NMDS.df.R14.BR1$dom)
MDS.lev.leg<-c("C-Bleach '14", "D-Bleach '14", "C-Recov '15", "D-Recov '15")
MDS.colors<-c("lightpink", "slategray1", "firebrick2", "dodgerblue2")

NMDS.plot<-ordiplot(NMDS.R14.BR1, type="n", main=substitute(paste("Reef 14-CRIMP2")), cex.main=1, display="sites", cex.lab=0.8, cex.axis=0.8, ylim=c(-0.4, 0.4), xlim=c(-0.6, 0.5), yaxt="n", ylab="", xaxt="n", xlab="")
axis(side = 1, labels = FALSE, tck = -0.05)
axis(side = 2, labels = FALSE, tck = -0.05)
abline(h = 0, lty = "dotted")
abline(v = 0, lty = "dotted")
points(NMDS.plot, "sites", cex=0.8, pch=16, col=MDS.colors)
ordiellipse(NMDS.plot, groups=NMDS.df.R14.BR1$Period:NMDS.df.R14.BR1$dom, draw="polygon", col=MDS.colors, alpha=150, kind="sd", conf=0.8)
par.new=T
plot(vars.R14.BR1, col="black", p.max=0.05, cex=0.8, lwd=1)


############### Reef 14 2015-2016

MDS.levels<-levels(NMDS.df.R14.BR2$Period:NMDS.df.R14.BR2$dom)
MDS.lev.leg<-c("C-Bleach '15", "D-Bleach '15", "C-Recov '16", "D-Recov '16")
MDS.colors<-c("lightpink", "slategray1", "firebrick2", "dodgerblue2")

NMDS.plot<-ordiplot(NMDS.R14.BR2, type="n", cex.main=1, display="sites", cex.lab=0.8, cex.axis=0.8, ylim=c(-0.4, 0.4), xlim=c(-0.6, 0.5), yaxt="n", ylab="")
axis(side = 2, labels = FALSE, tck = -0.05)
abline(h = 0, lty = "dotted")
abline(v = 0, lty = "dotted")
points(NMDS.plot, "sites", cex=0.8, pch=16, col=MDS.colors)
ordiellipse(NMDS.plot, groups=NMDS.df.R14.BR2$Period:NMDS.df.R14.BR2$dom, draw="polygon", col=MDS.colors, alpha=150, kind="sd", conf=0.8)
par.new=T
plot(vars.R14.BR2, col="black", p.max=0.05, cex=0.8, lwd=1)



dev.copy(pdf, "figures/4panel_NMDS.pdf", height=6, width=7, useDingbats=FALSE)
dev.off() 

```


```{r, eval=FALSE}
### symbiodinium data


###############################
## making figures, tables, analyses

###############################
# make a table by dominant symb

df

str(df)
print(levels(df$Period))

# 4 symbiont categories
symbcomp=table(df$syms, df$Period:df$Site) 
prop.table(symbcomp, margin = 2)

# 2 symbiont categories
domsymb=table(df$dom, df$Period:df$Site)
prop.table(domsymb, margin = 2)


# to specify order in figure, can use... ...(prop.table(symbcomp[,c(1,3,2,4)], 3,4,1,2,5,6
barplot(prop.table(symbcomp, margin = 2), col = c("slategray4", "slategray2", "dodgerblue", "darkturquoise"), main= "2014 - 2016 qPCR", xlab = "Site and Status", cex.names=0.65, ylab = "Proportion of Symbiont Types")
legend("topright", cex=0.8, bty="n", legend=c("C","CD", "D", "DC"), fill=c("slategray4", "slategray2", "dodgerblue", "darkturquoise")) #inset = c(-.25, 0), xpd = NA, x.intersp=0.1, y.intersp=0.7)

dev.copy(pdf, "Figures/symb_4 levels.pdf", encod="MacRoman", height=6, width=14)
dev.off()


#####################
## figures for 2014-2016 dominant symbiont composition figure (2 categories)

# to sepcify order in figure, can use... ...(prop.table(symbcomp[,c(1,3,2,4)],
barplot(prop.table(domsymb, margin = 2), col = c("slategray4", "darkturquoise"), main= "2014 - 2015 qPCR", xlab = "Site and Status", cex.names=0.65, ylab = "Proportion of Symbiont Types")
legend("topright", legend=c("C", "D"), bty="n", fill=c("slategray4", "darkturquoise"), inset = c(-.23, 0), xpd = NA, x.intersp=0.1, y.intersp=0.7)

dev.copy(pdf, "Figures/symb_2 levels.pdf", encod="MacRoman", height=6, width=14)
dev.off()

#Chi Squared test for independence
chisq.test(symbcomp) # p<0.01, accept Ha that symcomb IS related to events
chisq.test(domsymb) # p=0.1, accept Ho that domsymb is NOT related to events

prop.table(symbcomp, margin = 2)
par(mar=c(3, 4, 2, 6))


# to specify order in figure, can use... ...(prop.table(symbcomp[,c(1,3,2,4)],
barplot(prop.table(symbcomp, margin = 2), col = c("slategray4", "slategray2", "dodgerblue", "darkturquoise"), main= "2015 - 2016 qPCR", xlab = "Event and Site", cex.names=0.65, ylab = "Proportion of Symbiont Types")
legend("topright", legend=c("C","CD", "D", "DC"), fill=c("slategray4", "slategray2", "dodgerblue", "darkturquoise"))
#inset = c(-.15, 0), xpd = NA)

##########
prop.table(domsymb, margin = 2)
par(mar=c(3, 4, 2, 6))

barplot(prop.table(domsymb, margin = 2), col = c("slategray4", "darkturquoise"), main= "2015 - 2016 qPCR", xlab = "Site and Status", cex.names=0.65, ylab = "Proportion of Symbiont Types")
legend("topright", legend=c("C", "D"), fill=c("slategray4", "darkturquoise"), inset = c(-.15, 0), xpd = NA)
```
